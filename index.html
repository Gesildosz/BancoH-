<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Horas Extras</title>
<!-- Inclui a biblioteca SheetJS para leitura de Excel -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<!-- Inclui a biblioteca Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- NOVO: Inclui o plugin chartjs-plugin-datalabels para exibir valores nos gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<!-- NOVO: Inclui jsPDF para gera√ß√£o de PDF (VERS√ÉO ATUALIZADA) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- NOVO: Inclui jspdf-autotable para tabelas no PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<!-- NOVO: Inclui jspdf-plugin-svg para suporte a SVG (VERS√ÉO ATUALIZADA) -->
<script src="https://unpkg.com/jspdf-plugin-svg@2.0.0/dist/jspdf.plugin.svg.js"></script>
<style>
/* NOVO: Aplica box-sizing globalmente para um modelo de caixa consistente */
* {
box-sizing: border-box;
}

:root {
--primary-color: #4a90e2; /* Azul moderno */
--secondary-color: #50e3c2; /* Verde √°gua */
--text-dark: #34495e; /* Azul escuro para texto */
--text-light: #ecf0f1; /* Cinza claro para texto */
--bg-light: #f8f9fa; /* Fundo claro */
--bg-card: #ffffff; /* Fundo de card */
--border-color: #e0e6ed; /* Borda suave */
--error-color: #e74c3c; /* Vermelho de erro */
--success-color: #2ecc71; /* Verde de sucesso */
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background-color: var(--bg-light);
color: var(--text-dark);
margin: 0;
padding: 20px;
display: flex;
flex-direction: column;
align-items: center;
min-height: 100vh;
position: relative;
line-height: 1.6;
}
.container {
background-color: var(--bg-card);
padding: 40px;
border-radius: 12px;
box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
width: 100%;
max-width: 700px;
margin-bottom: 30px;
text-align: center;
}
h1 {
color: var(--primary-color);
margin-bottom: 15px;
font-size: 2.8em;
font-weight: 700;
}
.intro-text {
font-size: 1.15em;
color: #6c757d;
margin-bottom: 30px;
max-width: 500px;
margin-left: auto;
margin-right: auto;
}
h2 {
color: var(--text-dark);
text-align: center;
margin-bottom: 25px;
font-size: 2em;
font-weight: 600;
}
.section {
margin-bottom: 30px;
padding-bottom: 20px;
border-bottom: 1px solid var(--border-color);
}
.section:last-child {
border-bottom: none;
margin-bottom: 0;
padding-bottom: 0;
}
label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--text-dark);
text-align: left;
}
input[type="file"],
input[type="text"],
input[type="password"] {
width: 100%; /* NOVO: 100% de largura, box-sizing cuida do padding */
padding: 12px;
margin-bottom: 15px;
border: 1px solid var(--border-color);
border-radius: 8px;
font-size: 16px;
transition: border-color 0.3s ease, box-shadow 0.3s ease;
}
input[type="file"]:focus,
input[type="text"]:focus,
input[type="password"]:focus {
border-color: var(--primary-color);
box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
outline: none;
}
button {
background-color: var(--primary-color);
color: white;
padding: 12px 25px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: background-color 0.3s ease, transform 0.1s ease;
margin-right: 10px;
}
button:hover {
background-color: #3a7bd5; /* Tom mais escuro de azul */
transform: translateY(-2px);
}
button:active {
transform: translateY(0);
}
button:disabled {
background-color: #cccccc;
cursor: not-allowed;
}
.main-action-button {
background-color: var(--secondary-color); /* Verde √°gua para o bot√£o principal */
padding: 15px 30px;
font-size: 1.3em;
border-radius: 10px;
box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}
.main-action-button:hover {
background-color: #42d6b5;
box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
}

#uploadStatus {
margin-top: 10px;
font-style: italic;
color: #666;
}
/* NOVO: Estilos para o wrapper da tabela */
.table-responsive {
overflow-x: auto; /* Permite rolagem horizontal da tabela */
-webkit-overflow-scrolling: touch; /* Melhora a rolagem em iOS */
margin-top: 20px;
padding: 15px;
border: 1px solid var(--border-color);
border-radius: 8px;
background-color: #f9f9f9;
min-height: 50px;
}
table {
width: 100%;
border-collapse: collapse;
min-width: 600px; /* Garante que a tabela n√£o fique muito espremida em telas pequenas antes de rolar */
}
th, td {
border: 1px solid var(--border-color);
padding: 12px; /* Ajustado para melhor espa√ßamento */
text-align: left;
white-space: nowrap; /* Impede que o texto quebre em v√°rias linhas nas c√©lulas da tabela */
}
th {
background-color: #f2f4f7;
font-weight: bold;
color: var(--text-dark);
position: sticky; /* NOVO: Cabe√ßalho fixo */
top: 0; /* Fixa no topo do cont√™iner pai com overflow */
z-index: 1; /* Garante que o cabe√ßalho fique acima do conte√∫do da tabela */
box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); /* Sombra para destacar o sticky */
}
tr:nth-child(even) {
background-color: #fdfdfd;
}
tr:hover {
background-color: #f5f7fa;
}
.error {
color: var(--error-color);
font-weight: bold;
}
.success {
color: var(--success-color);
font-weight: bold;
}
/* Classe para saldo negativo */
.negative-saldo {
color: var(--error-color);
font-weight: bold;
}
.negative-message {
font-size: 0.9em;
color: var(--error-color);
margin-left: 5px;
}
/* Nova classe para formato inv√°lido */
.invalid-format {
color: var(--error-color);
font-weight: bold;
font-style: italic;
}

/* Estilos para o √≠cone do administrador */
#adminIcon {
position: absolute;
top: 20px;
right: 20px;
font-size: 2.5em;
cursor: pointer;
color: var(--text-dark);
transition: transform 0.2s ease-in-out;
z-index: 100;
}
#adminIcon:hover {
transform: rotate(15deg);
}

/* Estilos para o Modal (geral) */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7); /* Fundo mais escuro */
display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
opacity: 0;
visibility: hidden;
transition: opacity 0.3s ease, visibility 0.3s ease;
}
.modal-overlay.visible {
opacity: 1;
visibility: visible;
}
/* REMOVIDO: .hidden { display: none !important; } */
.modal-content {
background-color: var(--bg-card);
padding: 30px;
border-radius: 12px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
width: 90%;
max-width: 450px; /* Ajuste para o modal admin de login */
text-align: center;
position: relative;
transform: translateY(-20px);
transition: transform 0.3s ease, opacity 0.3s ease;
opacity: 0;
max-height: 95vh; /* NOVO: Limita a altura do modal */
overflow-y: auto; /* NOVO: Adiciona rolagem vertical se o conte√∫do exceder a altura */
}
.modal-overlay.visible .modal-content {
transform: translateY(0);
opacity: 1;
}
.modal-content h3 {
margin-top: 0;
color: var(--primary-color);
margin-bottom: 25px;
font-size: 1.8em;
font-weight: 600;
}
.modal-content .close-button {
position: absolute;
top: 15px;
right: 20px;
font-size: 1.8em;
cursor: pointer;
color: #888;
transition: color 0.2s ease;
z-index: 1001; /* NOVO: Garante que o bot√£o esteja acima de tudo */
}
.modal-content .close-button:hover {
color: var(--text-dark);
}
.modal-content button {
width: 100%;
margin-top: 20px;
}
#modalErrorMessage {
color: var(--error-color);
margin-top: 10px;
font-weight: bold;
}

/* Estilos espec√≠ficos para o Modal do Colaborador */
.colaborador-modal {
max-width: 700px; /* Mais expansivo */
padding: 40px;
display: flex;
flex-direction: column;
gap: 20px; /* Espa√ßamento entre os elementos */
background: linear-gradient(135deg, #e0f7fa 0%, #e6fcf7 100%); /* Degrad√™ */
box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
border: 1px solid rgba(255, 255, 255, 0.5);
}
.colaborador-modal h3 {
font-size: 2.2em;
margin-bottom: 10px;
color: var(--primary-color);
}
.colaborador-modal .datetime-display {
font-size: 0.95em;
color: #7f8c8d;
margin-bottom: 20px;
text-align: center;
}
.colaborador-modal .input-group {
display: flex;
gap: 15px;
align-items: flex-end;
margin-bottom: 20px;
}
.colaborador-modal .input-group label {
flex-grow: 1;
margin-bottom: 0; /* Resetar margem padr√£o */
}
.colaborador-modal .input-group input {
flex-grow: 1;
margin-bottom: 0; /* Resetar margem padr√£o */
}
.colaborador-modal .input-group button {
width: auto;
min-width: 120px;
margin-top: 0; /* Resetar margem padr√£o */
}
/* NOVO: Estilos para o cont√™iner de resultados de texto */
#textResults {
background-color: #fdfdfd;
border: 1px solid var(--border-color);
border-radius: 10px;
padding: 25px;
min-height: 120px;
text-align: left;
box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05);
display: flex;
flex-direction: column;
justify-content: center; /* Centraliza o conte√∫do verticalmente */
align-items: flex-start; /* Alinha o conte√∫do √† esquerda */
}
#textResults p {
margin: 8px 0;
font-size: 1.1em;
color: var(--text-dark);
}
#textResults .initial-message {
color: #7f8c8d;
font-style: italic;
text-align: center;
width: 100%;
}

/* NOVO: Estilos para o Modal de Conte√∫do do Administrador */
.admin-content-modal {
max-width: 900px; /* Mais largo para a tabela */
padding: 40px;
text-align: left; /* Alinha o texto √† esquerda dentro do modal */
}
.admin-content-modal h2 {
text-align: left; /* Garante que os t√≠tulos internos fiquem √† esquerda */
margin-top: 20px;
}
.admin-content-modal .section {
margin-bottom: 30px; /* Aumenta a margem para separar se√ß√µes */
padding-bottom: 20px;
border-bottom: 1px solid var(--border-color);
}
.admin-content-modal .section:last-child {
border-bottom: none;
}
.admin-content-modal button {
width: auto; /* Bot√µes dentro do modal admin n√£o precisam ser 100% */
margin-right: 10px;
}
/* NOVO: Estilos para a √°rea de exibi√ß√£o da tabela */
.table-display-area {
margin-top: 20px;
background-color: #fdfdfd;
border: 1px solid var(--border-color);
border-radius: 10px;
padding: 20px;
box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.05);
}
.table-display-area h4 {
font-size: 1.4em;
color: var(--primary-color);
margin-bottom: 10px;
text-align: center;
}
.table-display-area .records-count {
font-size: 0.95em;
color: #7f8c8d;
margin-bottom: 15px;
text-align: center;
}
.table-display-area .no-data-message {
text-align: center;
color: #7f8c8d;
font-style: italic;
padding: 20px;
}


/* Estilos para os Banners Informativos */
.banner-container {
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 25px;
width: 100%;
max-width: 800px;
margin-top: 30px;
}
.banner-card {
background-color: var(--bg-card);
padding: 30px;
border-radius: 15px;
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
flex: 1;
min-width: 280px;
max-width: 350px;
text-align: left;
transition: transform 0.2s ease, box-shadow 0.2s ease;
border-left: 5px solid var(--primary-color); /* Detalhe de cor */
}
.banner-card:hover {
transform: translateY(-8px);
box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}
.banner-card h3 {
color: var(--primary-color);
margin-top: 0;
margin-bottom: 12px;
font-size: 1.5em;
display: flex;
align-items: center;
font-weight: 600;
}
.banner-card h3 span {
margin-right: 12px;
font-size: 1.3em;
color: var(--secondary-color); /* Cor do √≠cone do banner */
}
.banner-card p {
color: #555;
font-size: 1em;
line-height: 1.6;
}

/* Classe para esconder elementos */
.hidden {
display: none !important;
}

/* NOVO: Estilos para o cont√™iner do gr√°fico */
.chart-section {
margin-top: 20px;
padding-top: 15px;
border-top: 1px solid var(--border-color);
text-align: center;
}
.chart-section h4 {
color: var(--text-dark);
margin-bottom: 15px;
font-size: 1.2em;
}
.chart-summary {
font-size: 1.1em;
font-weight: 600;
margin-top: 15px;
}
.chart-summary.positive {
color: var(--success-color);
}
.chart-summary.negative {
color: var(--error-color);
}

/* NOVO: Estilos para o modal de hist√≥rico */
.history-modal {
max-width: 900px; /* Mais largo para os dois gr√°ficos */
padding: 40px;
display: flex;
flex-direction: column;
gap: 30px; /* Espa√ßamento entre os gr√°ficos */
}

/* NOVO: Estilos para o wrapper do canvas do gr√°fico */
.chart-canvas-wrapper {
position: relative;
width: 100%;
height: 250px; /* Altura fixa para o wrapper */
}
.chart-canvas-wrapper canvas {
width: 100% !important; /* Garante que o canvas preencha a largura do wrapper */
height: 100% !important; /* Garante que o canvas preencha a altura do wrapper */
}

/* NOVO: Estilos para a logo nos modais */
.modal-logo-container {
font-size: 2em; /* Tamanho ajustado para modais */
font-weight: bold;
color: #333;
display: flex;
align-items: baseline;
justify-content: center; /* Centraliza a logo */
margin-bottom: 20px; /* Espa√ßamento abaixo da logo */
}
.modal-logo-text {
color: #0056b3; /* Azul escuro */
}
.modal-logo-plus {
color: #28a745; /* Verde vibrante */
margin-left: 5px;
font-size: 1.2em;
transform: translateY(-5px); /* Ajusta a posi√ß√£o vertical do B+ */
display: inline-block;
}

/* NOVO: Estilos para o spinner de carregamento */
.spinner {
border: 4px solid rgba(0, 0, 0, 0.1);
border-left-color: var(--primary-color);
border-radius: 50%;
width: 24px;
height: 24px;
animation: spin 1s linear infinite;
display: inline-block;
vertical-align: middle;
margin-left: 10px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* NOVO: Estilos para o grupo de input e bot√£o de busca */
.search-input-group {
display: flex;
gap: 10px;
margin-bottom: 15px;
align-items: flex-end;
}
.search-input-group label {
flex-grow: 1;
margin-bottom: 0;
}
.search-input-group input {
flex-grow: 1;
margin-bottom: 0;
}
.search-input-group button {
width: auto;
min-width: 100px;
margin-top: 0;
}

/* NOVO: Estilos para as abas dentro do modal do colaborador */
.tabs-container {
display: flex;
margin-bottom: 20px;
border-bottom: 1px solid var(--border-color);
}
.tab-button {
flex: 1;
padding: 10px 15px;
border: none;
background-color: transparent;
color: var(--text-dark);
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
border-bottom: 3px solid transparent;
margin-right: 0; /* Reset default button margin */
border-radius: 0; /* Reset default button border-radius */
}
.tab-button:hover {
background-color: #f0f2f5;
}
.tab-button.active {
color: var(--primary-color);
border-bottom-color: var(--primary-color);
background-color: var(--bg-card);
}
.tab-content {
padding-top: 20px;
}
.tab-content.hidden {
display: none !important;
}

/* NOVO: Estilos para a barra de progresso */
.progress-container {
width: 100%;
background-color: #e0e0e0;
border-radius: 5px;
margin-top: 15px;
height: 20px;
overflow: hidden;
position: relative;
}

.progress-bar {
height: 100%;
width: 0%;
background-color: var(--primary-color);
border-radius: 5px;
text-align: center;
color: white;
line-height: 20px; /* Centraliza o texto verticalmente */
font-size: 0.8em;
transition: width 0.3s ease-in-out;
position: absolute;
left: 0;
top: 0;
}

.progress-text {
position: absolute;
width: 100%;
text-align: center;
line-height: 20px;
font-size: 0.8em;
color: var(--text-dark); /* Cor do texto sobre a barra */
z-index: 1; /* Garante que o texto fique acima da barra */
}


/* Responsividade */
@media (max-width: 768px) {
.container, .colaborador-modal, .modal-content {
    padding: 25px;
    margin-bottom: 20px;
}
h1 {
    font-size: 2.2em;
}
.intro-text {
    font-size: 1em;
}
.main-action-button {
    font-size: 1.1em;
    padding: 12px 25px;
}
.colaborador-modal .input-group, .admin-content-modal .section > button {
    flex-direction: column;
    align-items: stretch;
}
.colaborador-modal .input-group button, .admin-content-modal button {
    width: 100%;
    min-width: unset;
    margin-right: 0; /* Remove margin-right for full width buttons */
}
.banner-container {
    flex-direction: column;
    align-items: center;
}
.banner-card {
    width: 100%;
    max-width: 90%;
}
#adminIcon {
    font-size: 2em;
    top: 15px;
    right: 15px;
}
.history-modal {
    padding: 25px;
    gap: 20px;
}
.modal-logo-container {
    font-size: 1.8em; /* Ajuste para telas menores */
}
.table-display-area {
    padding: 15px;
}
.search-input-group {
    flex-direction: column;
    align-items: stretch;
}
.search-input-group button {
    width: 100%;
}
}

@media (max-width: 480px) {
body {
    padding: 10px;
}
.container {
    padding: 20px;
}
/* NOVO: Ajuste de padding para todos os modais em telas muito pequenas */
.modal-content, .colaborador-modal, .history-modal, .admin-content-modal {
    padding: 20px; /* Reduz o padding para caber mais conte√∫do */
}
h1 {
    font-size: 1.8em;
}
h2 {
    font-size: 1.5em;
}
.modal-content h3 {
    font-size: 1.5em;
}
.modal-content .close-button {
    font-size: 1.5em;
}
input[type="file"], input[type="text"], input[type="password"], button {
    font-size: 14px;
    padding: 10px;
}
.modal-logo-container {
    font-size: 1.5em; /* Ajuste para telas muito pequenas */
}
.table-display-area {
    padding: 10px;
}
}
</style>
</head>
<body>
<!-- √çcone do Administrador -->
<div id="adminIcon" title="√Årea do Administrador">üîí</div>

<div class="container">
<h1>Bem-vindo ao Sistema de Horas Extras</h1>
<p class="intro-text">Consulte suas horas extras de forma r√°pida e f√°cil. Mantenha-se atualizado com seu saldo e informa√ß√µes importantes.</p>
<button id="openColaboradorModalButton" class="main-action-button">Consultar Minhas Horas</button>
</div>

<!-- Informative Banners Section -->
<div class="banner-container">
<div class="banner-card">
<h3><span>üìÖ</span> Pr√≥ximos Prazos</h3>
<p>Lembre-se de registrar suas horas e verificar seu saldo at√© o dia 25 de cada m√™s para evitar inconsist√™ncias.</p>
</div>
<div class="banner-card">
<h3><span>üí°</span> Dica R√°pida</h3>
<p>Em caso de d√∫vidas sobre seu saldo ou o processo de horas extras, n√£o hesite em consultar seu l√≠der direto ou o departamento de Recursos Humanos.</p>
</div>
<div class="banner-card">
<h3><span>üîí</span> Sua Seguran√ßa</h3>
<p>Seus dados s√£o confidenciais e protegidos. Mantenha o n√∫mero da sua chapa em sigilo e evite compartilh√°-lo.</p>
</div>
</div>

<!-- Modal de Login do Administrador (inicialmente oculto) -->
<div id="adminModalOverlay" class="modal-overlay">
<div class="modal-content">
<span class="close-button" id="closeAdminModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Acesso de Administrador</h3>
<label for="adminPassword">Senha:</label>
<input type="password" id="adminPassword" placeholder="Digite a senha">
<button id="adminLoginButton">Entrar</button>
<p id="modalErrorMessage" class="error hidden"></p>
</div>
</div>

<!-- NOVO: Modal de Conte√∫do do Administrador (inicialmente oculto) -->
<div id="adminContentModalOverlay" class="modal-overlay">
<div class="modal-content admin-content-modal">
<span class="close-button" id="closeAdminContentModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>√Årea do Administrador</h3>
<div class="section">
    <h2>Carregar Dados</h2>
    <!-- Removidos os elementos de upload de arquivo -->
    <p>Os dados s√£o carregados automaticamente do arquivo `horas.html`.</p>
</div>

<!-- NOVO: Se√ß√£o do Gr√°fico de Horas por L√≠der -->
<div class="section">
    <h2>Saldo de Horas por L√≠der</h2>
    <div class="chart-canvas-wrapper">
        <canvas id="leaderOvertimeChart"></canvas>
    </div>
</div>

<div class="section">
    <h2>Vis√£o Geral</h2>
    <div class="search-input-group">
        <label for="cargoInputAdmin">Buscar por Cargo:</label>
        <input type="text" id="cargoInputAdmin" placeholder="Digite o cargo">
        <button id="searchByCargoButton" disabled>Buscar</button>
    </div>
    <button id="showAllButton" disabled>Mostrar Todos os Registros</button>
    <!-- NOVO: Bot√£o para imprimir relat√≥rio PDF -->
    <button id="printPdfButton" disabled>Gerar Relat√≥rio PDF <span id="pdfSpinner" class="spinner hidden"></span></button>
    <!-- NOVO: Wrapper para a tabela responsiva com t√≠tulo e contagem -->
    <div id="tableDisplayArea" class="table-display-area">
        <h4 id="tableTitle"></h4>
        <p id="recordsCount" class="records-count"></p>
        <div id="allRecordsTable" class="table-responsive">
            <p class="no-data-message">Carregando dados...</p>
        </div>
    </div>
</div>

<!-- NOVO: Se√ß√£o de Envio por WhatsApp -->
<div class="section">
    <h2>Enviar Relat√≥rio por WhatsApp</h2>
    <div class="search-input-group">
        <label for="chapaWhatsappInput">Chapa do Colaborador:</label>
        <input type="text" id="chapaWhatsappInput" placeholder="Digite a chapa do colaborador">
        <span id="whatsappCollaboratorNameDisplay" style="margin-left: 10px; font-weight: bold; color: var(--primary-color);"></span>
    </div>
    <div class="search-input-group">
        <label for="whatsappPhoneNumberInput">Telefone (opcional):</label>
        <input type="text" id="whatsappPhoneNumberInput" placeholder="(XX) XXXXX-XXXX">
        <button id="sendWhatsappButton" disabled>Enviar via WhatsApp <span id="whatsappSpinner" class="spinner hidden"></span></button>
        <!-- NOVO: Bot√£o para baixar PDF espec√≠fico -->
        <button id="downloadSpecificPdfButton" disabled>Baixar Relat√≥rio PDF <span id="downloadPdfSpinner" class="spinner hidden"></span></button>
    </div>
    <p id="whatsappStatusMessage"></p>
</div>

<!-- NOVO: Se√ß√£o de Gerenciamento de Telefones -->
<div class="section">
    <h2>Gerenciar Telefones de Colaboradores</h2>
    <div class="search-input-group">
        <label for="manageChapaInput">Chapa do Colaborador:</label>
        <input type="text" id="manageChapaInput" placeholder="Digite a chapa">
        <span id="manageCollaboratorNameDisplay" style="margin-left: 10px; font-weight: bold; color: #6c757d;"></span>
    </div>
    <div class="search-input-group">
        <label for="managePhoneNumberInput">Telefone (para cadastro/atualiza√ß√£o):</label>
        <input type="text" id="managePhoneNumberInput" placeholder="(XX) XXXXX-XXXX">
        <button id="savePhoneNumberButton">Salvar Telefone</button>
    </div>
    <p id="managePhoneNumberStatusMessage"></p>
</div>
</div>
</div>

<!-- Modal do Colaborador (inicialmente oculto) -->
<div id="colaboradorModalOverlay" class="modal-overlay">
<div class="modal-content colaborador-modal">
<span class="close-button" id="closeColaboradorModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>

<!-- NOVO: Abas para navega√ß√£o dentro do modal do colaborador -->
<div class="tabs-container">
    <button id="consultarHorasTabButton" class="tab-button active">Consultar Horas</button>
    <button id="atualizarDadosTabButton" class="tab-button">Atualizar Dados</button>
</div>

<!-- Conte√∫do da aba "Consultar Horas" -->
<div id="consultarHorasTabContent" class="tab-content active">
    <h3>Consulta de Horas Extras</h3>
    <div class="datetime-display" id="currentDateTime"></div>
    <div class="input-group">
        <label for="chapaInputModal">N√∫mero da Chapa:</label>
        <input type="text" id="chapaInputModal" placeholder="Digite o n√∫mero da chapa">
        <button id="searchButtonModal">Buscar</button>
    </div>
    <div id="searchResultsContainer">
        <div id="textResults">
            <p class="initial-message">Digite sua chapa para consultar seu saldo.</p>
        </div>
        <button id="showHistoryButton" class="main-action-button hidden" style="margin-top: 20px;">Hist√≥rico de Evolu√ß√£o</button>
    </div>
</div>

<!-- NOVO: Conte√∫do da aba "Atualizar Dados" -->
<div id="atualizarDadosTabContent" class="tab-content hidden">
    <h3>Atualizar Meus Dados</h3>
    <p>Edite suas informa√ß√µes e credenciais de acesso.</p>
    <label for="updateNomeCompleto">Nome Completo:</label>
    <input type="text" id="updateNomeCompleto" placeholder="Seu nome completo" readonly>
    <label for="updateChapa">Chapa:</label>
    <input type="text" id="updateChapa" readonly>
    <label for="updateCargo">Cargo:</label>
    <input type="text" id="updateCargo" readonly>
    <label for="updateTelefone">Telefone:</label>
    <input type="text" id="updateTelefone" placeholder="(XX) XXXXX-XXXX">

    <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--primary-color); text-align: left;">Alterar Senha e Frase Secreta</h4>
    <label for="updateNewPassword">Nova Senha:</label>
    <input type="password" id="updateNewPassword">
    <label for="updateConfirmNewPassword">Confirmar Nova Senha:</label>
    <input type="password" id="updateConfirmNewPassword">
    <label for="updateSecretPhrase">Nova Frase Secreta:</label>
    <input type="text" id="updateSecretPhrase" placeholder="Ex: Nome do seu primeiro pet">
    <label for="updateConfirmSecretPhrase">Confirmar Nova Frase Secreta:</label>
    <input type="text" id="updateConfirmSecretPhrase">

    <button id="saveChangesButton">Salvar Altera√ß√µes</button>
    <p id="updateDataErrorMessage" class="error hidden"></p>
    <p id="updateDataSuccessMessage" class="success hidden"></p>
</div>
</div>
</div>

<!-- NOVO: Modal de Hist√≥rico de Evolu√ß√£o (inicialmente oculto) -->
<div id="historyModalOverlay" class="modal-overlay">
<div class="modal-content history-modal">
<span class="close-button" id="closeHistoryModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Hist√≥rico de Evolu√ß√£o de Horas Extras</h3>
<div class="chart-section">
    <h4 id="totalOvertimeChartTitle">Saldo Total de Horas (Positivas e Negativas)</h4>
    <div class="chart-canvas-wrapper">
        <canvas id="totalOvertimeChart"></canvas>
    </div>
    <p id="totalPercentageChange" class="chart-summary"></p>
</div>
<div class="chart-section">
    <h4 id="positiveOvertimeChartTitle">Horas Positivas</h4>
    <div class="chart-canvas-wrapper">
        <canvas id="positiveOvertimeChart"></canvas>
    </div>
    <p id="positivePercentageChange" class="chart-summary"></p>
</div>
</div>
</div>

<!-- NOVO: Modal de Cadastro (Primeiro Acesso) -->
<div id="registrationModalOverlay" class="modal-overlay">
<div class="modal-content">
<span class="close-button" id="closeRegistrationModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Primeiro Acesso: Cadastro</h3>
<p>Por favor, preencha seus dados para continuar.</p>
<label for="regNomeCompleto">Nome Completo:</label>
<input type="text" id="regNomeCompleto" placeholder="Seu nome completo">
<label for="regChapa">Chapa:</label>
<input type="text" id="regChapa" readonly> <!-- Pre-filled and read-only -->
<label for="regTelefone">Telefone:</label>
<input type="text" id="regTelefone" placeholder="(XX) XXXXX-XXXX">
<button id="submitRegistrationButton">Finalizar Cadastro</button>
<p id="registrationErrorMessage" class="error hidden"></p>
</div>
</div>

<!-- NOVO: Modal de Defini√ß√£o de Senha -->
<div id="passwordSetupModalOverlay" class="modal-overlay">
<div class="modal-content">
<span class="close-button" id="closePasswordSetupModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Definir Nova Senha e Frase Secreta</h3>
<p>Crie uma senha e uma frase secreta para seus futuros acessos.</p>
<label for="setupNewPassword">Nova Senha:</label>
<input type="password" id="setupNewPassword">
<label for="setupConfirmPassword">Confirmar Senha:</label>
<input type="password" id="setupConfirmPassword">
<label for="setupSecretPhrase">Frase Secreta:</label>
<input type="text" id="setupSecretPhrase" placeholder="Ex: Nome do seu primeiro pet">
<label for="setupConfirmSecretPhrase">Confirmar Nova Frase Secreta:</label>
<input type="text" id="setupConfirmSecretPhrase">
<button id="setPasswordButton">Cadastrar Senha e Frase</button>
<p id="passwordSetupErrorMessage" class="error hidden"></p>
</div>
</div>

<!-- NOVO: Modal de Solicita√ß√£o de Senha (para usu√°rios existentes) -->
<div id="passwordPromptModalOverlay" class="modal-overlay">
<div class="modal-content">
<span class="close-button" id="closePasswordPromptModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Acesso com Senha</h3>
<p>Por favor, digite sua senha para a chapa <span id="promptChapaDisplay"></span>.</p>
<label for="promptPassword">Senha:</label>
<input type="password" id="promptPassword">
<button id="submitPasswordPromptButton">Entrar</button>
<button id="forgotPasswordButton" class="secondary-button" style="background-color: #6c757d; margin-top: 10px;">Esqueci minha senha</button>
<p id="passwordPromptErrorMessage" class="error hidden"></p>
</div>
</div>

<!-- NOVO: Modal de Recupera√ß√£o de Senha -->
<div id="forgotPasswordModalOverlay" class="modal-overlay">
<div class="modal-content">
<span class="close-button" id="closeForgotPasswordModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Recuperar Senha</h3>
<p>Para redefinir sua senha, informe sua chapa, o telefone cadastrado e sua frase secreta.</p>
<label for="forgotChapa">Chapa:</label>
<input type="text" id="forgotChapa" placeholder="Digite sua chapa">
<label for="forgotTelefone">Telefone:</label>
<input type="text" id="forgotTelefone" placeholder="(XX) XXXXX-XXXX">
<label for="forgotSecretPhrase">Frase Secreta:</label>
<input type="text" id="forgotSecretPhrase" placeholder="Digite sua frase secreta">
<button id="verifyForgotPasswordButton">Verificar</button>
<p id="forgotPasswordErrorMessage" class="error hidden"></p>
</div>
</div>

<!-- NOVO: Modal de Confirma√ß√£o de Token -->
<div id="tokenConfirmationModalOverlay" class="modal-overlay">
<div class="modal-content">
<span class="close-button" id="closeTokenConfirmationModalButton">&times;</span>
<div class="modal-logo-container">
    <span class="modal-logo-text">Banco Horas</span><span class="modal-logo-plus">B+</span>
</div>
<h3>Confirma√ß√£o de Altera√ß√µes</h3>
<p>Um token de seguran√ßa foi gerado. Digite-o abaixo para confirmar as altera√ß√µes.</p>
<p id="tokenDisplay" style="font-size: 1.5em; font-weight: bold; color: var(--primary-color); margin: 15px 0;"></p>
<p id="tokenTimerDisplay" style="font-size: 0.9em; color: #7f8c8d;"></p>
<label for="tokenInput">Token:</label>
<input type="text" id="tokenInput" placeholder="Digite o token de 6 d√≠gitos">
<button id="confirmTokenButton">Confirmar Token</button>
<button id="resendTokenButton" class="secondary-button" style="background-color: #6c757d; margin-top: 10px;">Gerar Novo Token</button>
<p id="tokenErrorMessage" class="error hidden"></p>
</div>
</div>

<script>
// NOVO: Registra o plugin datalabels globalmente
Chart.register(ChartDataLabels);

// Vari√°veis globais para armazenar os dados do Excel e hist√≥rico
// Dados agora s√£o apenas em mem√≥ria, n√£o persistidos
let overtimeData = []; 
let employeeHistory = {}; 
let registeredUsers = {};

let currentConsultedRecord = null; 
let totalOvertimeChartInstance = null; 
let positiveOvertimeChartInstance = null; 
let leaderOvertimeChartInstance = null; 

let chapaBeingProcessed = null; 
let pendingUserDataChanges = null; 
let generatedToken = null; 
let tokenTimer = null; 
let tokenExpirationTime = null; 


// Define as colunas que s√£o esperadas e que devem ser exibidas
const REQUIRED_DISPLAY_COLUMNS = ['CHAPA', 'Nome', 'Fun√ß√£o', 'L√≠der', 'Turno', 'Status']; // Atualizado para as colunas do horas.html
const ADMIN_PASSWORD = '3360ba'; // Senha do administrador
const TOKEN_EXPIRATION_SECONDS = 120; // NOVO: Tempo de expira√ß√£o do token em segundos (2 minutos)

// NOVO: SVG do logotipo em Base64
const LOGO_BASE64_SVG = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9PTUwIiB2aWV3Qm94PSIwIDAgMjAwIDUwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iNTAiIGZpbGw9IiNmZmZmZmYiLz4KICA8dGV4dCB4PSIxMCIgeT0iMzUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzMCIgZmlsbD0iIzAwNTY2MyI+QmFuY28gSG9yYXM8L3RleHQ+CiAgPHRleHQgeD0iMTYwIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzI4YTc0NSI+QjwrPC90ZXh0Pgo8L3N2Zz4=';


// Elementos da interface principal
const openColaboradorModalButton = document.getElementById('openColaboradorModalButton');

// Elementos do Administrador e Modal Admin de Login
const adminIcon = document.getElementById('adminIcon');
const adminModalOverlay = document.getElementById('adminModalOverlay');
const adminPasswordInput = document.getElementById('adminPassword');
const adminLoginButton = document.getElementById('adminLoginButton');
const modalErrorMessage = document.getElementById('modalErrorMessage');
const closeAdminModalButton = document.getElementById('closeAdminModalButton');

// NOVO: Elementos do Modal de Conte√∫do do Administrador
const adminContentModalOverlay = document.getElementById('adminContentModalOverlay');
const closeAdminContentModalButton = document.getElementById('closeAdminContentModalButton');

// Elementos do Modal Colaborador
const colaboradorModalOverlay = document.getElementById('colaboradorModalOverlay');
const closeColaboradorModalButton = document.getElementById('closeColaboradorModalButton');
const chapaInputModal = document.getElementById('chapaInputModal');
const searchButtonModal = document.getElementById('searchButtonModal');
const textResults = document.getElementById('textResults');
const currentDateTimeDisplay = document.getElementById('currentDateTime');
const showHistoryButton = document.getElementById('showHistoryButton'); // NOVO: Bot√£o de hist√≥rico

// NOVO: Elementos do Modal de Hist√≥rico
const historyModalOverlay = document.getElementById('historyModalOverlay');
const closeHistoryModalButton = document.getElementById('closeHistoryModalButton');
const totalOvertimeChartTitle = document.getElementById('totalOvertimeChartTitle'); // NOVO: T√≠tulo do gr√°fico de saldo total
const positiveOvertimeChartTitle = document.getElementById('positiveOvertimeChartTitle'); // NOVO: T√≠tulo do gr√°fico de horas positivas
const totalPercentageChangeDisplay = document.getElementById('totalPercentageChange');
const positivePercentageChangeDisplay = document.getElementById('positivePercentageChange');

// NOVO: Elementos do Modal de Cadastro
const registrationModalOverlay = document.getElementById('registrationModalOverlay');
const closeRegistrationModalButton = document.getElementById('closeRegistrationModalButton');
const regNomeCompletoInput = document.getElementById('regNomeCompleto');
const regChapaInput = document.getElementById('regChapa');
const regTelefoneInput = document.getElementById('regTelefone');
const submitRegistrationButton = document.getElementById('submitRegistrationButton');
const registrationErrorMessage = document.getElementById('registrationErrorMessage');

// NOVO: Elementos do Modal de Defini√ß√£o de Senha
const passwordSetupModalOverlay = document.getElementById('passwordSetupModalOverlay');
const closePasswordSetupModalButton = document.getElementById('closePasswordSetupModalButton');
const setPasswordButton = document.getElementById('setPasswordButton');
const passwordSetupErrorMessage = document.getElementById('passwordSetupErrorMessage');

// NOVO: Elementos do Modal de Solicita√ß√£o de Senha
const passwordPromptModalOverlay = document.getElementById('passwordPromptModalOverlay');
const closePasswordPromptModalButton = document.getElementById('closePasswordPromptModalButton');
const promptChapaDisplay = document.getElementById('promptChapaDisplay');
const promptPasswordInput = document.getElementById('promptPassword');
const submitPasswordPromptButton = document.getElementById('submitPasswordPromptButton');
const passwordPromptErrorMessage = document.getElementById('passwordPromptErrorMessage');
const forgotPasswordButton = document.getElementById('forgotPasswordButton'); // NOVO: Bot√£o Esqueci minha senha

// NOVO: Elementos do Modal de Recupera√ß√£o de Senha
const forgotPasswordModalOverlay = document = document.getElementById('forgotPasswordModalOverlay');
const closeForgotPasswordModalButton = document.getElementById('closeForgotPasswordModalButton');
const forgotChapaInput = document.getElementById('forgotChapa');
const forgotTelefoneInput = document.getElementById('forgotTelefone');
const forgotSecretPhraseInput = document.getElementById('forgotSecretPhrase'); // NOVO
const verifyForgotPasswordButton = document.getElementById('verifyForgotPasswordButton');
const forgotPasswordErrorMessage = document.getElementById('forgotPasswordErrorMessage');

// NOVO: Elementos do Modal de Confirma√ß√£o de Token
const tokenConfirmationModalOverlay = document.getElementById('tokenConfirmationModalOverlay');
const closeTokenConfirmationModalButton = document.getElementById('closeTokenConfirmationModalButton');
const tokenDisplay = document.getElementById('tokenDisplay');
const tokenTimerDisplay = document.getElementById('tokenTimerDisplay');
const tokenInput = document.getElementById('tokenInput');
const confirmTokenButton = document.getElementById('confirmTokenButton');
const resendTokenButton = document.getElementById('resendTokenButton');
const tokenErrorMessage = document.getElementById('tokenErrorMessage');


// Elementos da √°rea de upload e vis√£o geral (agora dentro do modal de conte√∫do admin)
// Removidos excelFileInput, uploadButton, uploadStatus, progressBarContainer, progressBar, progressText
const showAllButton = document.getElementById('showAllButton');
const tableDisplayArea = document.getElementById('tableDisplayArea'); // NOVO: O wrapper da tabela
const tableTitle = document.getElementById('tableTitle'); // NOVO: T√≠tulo da tabela
const recordsCount = document.getElementById('recordsCount'); // NOVO: Contagem de registros
const allRecordsTable = document.getElementById('allRecordsTable'); // Agora √© o wrapper da tabela em si
const leaderOvertimeChartCanvas = document.getElementById('leaderOvertimeChart'); // NOVO: Canvas do gr√°fico de l√≠deres
const printPdfButton = document.getElementById('printPdfButton'); // NOVO: Bot√£o de imprimir PDF
const pdfSpinner = document.getElementById('pdfSpinner'); // NOVO: Spinner do PDF
const cargoInputAdmin = document.getElementById('cargoInputAdmin'); // NOVO: Input de busca por cargo
const searchByCargoButton = document.getElementById('searchByCargoButton'); // NOVO: Bot√£o de busca por cargo

// NOVO: Elementos para as abas do modal do colaborador
const consultarHorasTabButton = document.getElementById('consultarHorasTabButton');
const atualizarDadosTabButton = document.getElementById('atualizarDadosTabButton');
const consultarHorasTabContent = document.getElementById('consultarHorasTabContent');
const atualizarDadosTabContent = document.getElementById('atualizarDadosTabContent');

// NOVO: Elementos para o formul√°rio de atualiza√ß√£o de dados
const updateNomeCompletoInput = document.getElementById('updateNomeCompleto');
const updateChapaInput = document.getElementById('updateChapa');
const updateCargoInput = document.getElementById('updateCargo');
const updateTelefoneInput = document.getElementById('updateTelefone');
const updateNewPasswordInput = document.getElementById('updateNewPassword');
const updateConfirmNewPasswordInput = document.getElementById('updateConfirmNewPassword');
const updateSecretPhraseInput = document.getElementById('updateSecretPhrase');
const updateConfirmSecretPhraseInput = document.getElementById('updateConfirmSecretPhrase');
const saveChangesButton = document.getElementById('saveChangesButton');
const updateDataErrorMessage = document.getElementById('updateDataErrorMessage');
const updateDataSuccessMessage = document.getElementById('updateDataSuccessMessage');

// NOVO: Elementos da se√ß√£o de WhatsApp
const chapaWhatsappInput = document.getElementById('chapaWhatsappInput');
const whatsappCollaboratorNameDisplay = document.getElementById('whatsappCollaboratorNameDisplay'); // NOVO: Elemento para exibir o nome
const whatsappPhoneNumberInput = document.getElementById('whatsappPhoneNumberInput'); // NOVO: Input para telefone manual
const sendWhatsappButton = document.getElementById('sendWhatsappButton');
const whatsappStatusMessage = document.getElementById('whatsappStatusMessage');
const whatsappSpinner = document.getElementById('whatsappSpinner');
// NOVO: Elementos para o bot√£o de download espec√≠fico
const downloadSpecificPdfButton = document.getElementById('downloadSpecificPdfButton');
const downloadPdfSpinner = document.getElementById('downloadPdfSpinner');


// NOVO: Elementos da se√ß√£o de Gerenciamento de Telefones
const manageChapaInput = document.getElementById('manageChapaInput');
const manageCollaboratorNameDisplay = document.getElementById('manageCollaboratorNameDisplay');
const managePhoneNumberInput = document.getElementById('managePhoneNumberInput');
const savePhoneNumberButton = document.getElementById('savePhoneNumberButton');
const managePhoneNumberStatusMessage = document.getElementById('managePhoneNumberStatusMessage');


// Fun√ß√µes para controlar o modal Admin de Login
function showAdminModal() {
console.log('showAdminModal: Chamado');
adminModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
adminPasswordInput.value = '';
modalErrorMessage.classList.add('hidden');
adminPasswordInput.focus();
console.log('showAdminModal: Classes do overlay:', adminModalOverlay.classList);
}

function hideAdminModal() {
console.log('hideAdminModal: Chamado');
adminModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
adminPasswordInput.value = '';
modalErrorMessage.classList.add('hidden');
console.log('hideAdminModal: Classes do overlay:', adminModalOverlay.classList);
}

// NOVO: Fun√ß√µes para controlar o Modal de Conte√∫do do Administrador
function showAdminContentModal() {
console.log('showAdminContentModal: Chamado');
adminContentModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
if (overtimeData.length > 0) {
    showAllButton.disabled = false;
    printPdfButton.disabled = false; // Habilita o bot√£o de PDF
    searchByCargoButton.disabled = false; // Habilita o bot√£o de busca por cargo
    sendWhatsappButton.disabled = false; // Habilita o bot√£o de WhatsApp
    downloadSpecificPdfButton.disabled = false; // NOVO: Habilita o bot√£o de download espec√≠fico
    displayRecordsAndChart(overtimeData, 'Todos os Registros'); // Exibe todos os registros e o gr√°fico ao abrir
} else {
    showAllButton.disabled = true;
    printPdfButton.disabled = true; // Desabilita o bot√£o de PDF
    searchByCargoButton.disabled = true; // Desabilita o bot√£o de busca por cargo
    sendWhatsappButton.disabled = true; // Desabilita o bot√£o de WhatsApp
    downloadSpecificPdfButton.disabled = true; // NOVO: Desabilita o bot√£o de download espec√≠fico
    // NOVO: Limpa o gr√°fico de l√≠deres se n√£o houver dados
    if (leaderOvertimeChartInstance) {
        leaderOvertimeChartInstance.destroy();
        leaderOvertimeChartInstance = null;
    }
    // NOVO: Limpa a √°rea da tabela ao abrir o modal de admin
    tableTitle.textContent = '';
    recordsCount.textContent = '';
    allRecordsTable.innerHTML = '<p class="no-data-message">Carregando dados...</p>';
}
// Limpa o nome do colaborador ao abrir o modal de admin
whatsappCollaboratorNameDisplay.textContent = '';
manageChapaInput.value = ''; // Limpa o campo de chapa do gerenciamento
managePhoneNumberInput.value = ''; // Limpa o campo de telefone do gerenciamento
manageCollaboratorNameDisplay.textContent = ''; // Limpa o nome do gerenciamento
managePhoneNumberStatusMessage.classList.add('hidden'); // Esconde a mensagem de status
console.log('showAdminContentModal: Classes do overlay:', adminContentModalOverlay.classList);
}

function hideAdminContentModal() {
console.log('hideAdminContentModal: Chamado');
adminContentModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
// NOVO: Destr√≥i a inst√¢ncia do gr√°fico de l√≠deres ao fechar o modal
if (leaderOvertimeChartInstance) {
    leaderOvertimeChartInstance.destroy();
    leaderOvertimeChartInstance = null;
}
// Limpa o nome do colaborador ao fechar o modal de admin
whatsappCollaboratorNameDisplay.textContent = '';
manageChapaInput.value = ''; // Limpa o campo de chapa do gerenciamento
managePhoneNumberInput.value = ''; // Limpa o campo de telefone do gerenciamento
manageCollaboratorNameDisplay.textContent = ''; // Limpa o nome do gerenciamento
managePhoneNumberStatusMessage.classList.add('hidden'); // Esconde a mensagem de status
console.log('hideAdminContentModal: Classes do overlay:', adminContentModalOverlay.classList);
}

// NOVO: Fun√ß√£o para resetar o conte√∫do do modal do colaborador
function resetColaboradorModalContent() {
chapaInputModal.value = '';
textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
showHistoryButton.classList.add('hidden');
currentConsultedRecord = null;
updateDateTime();
chapaInputModal.focus();
showTab('consultarHoras'); // Garante que a aba de consulta esteja ativa ao resetar
}

// Fun√ß√µes para controlar o modal Colaborador (AGORA APENAS VISIBILIDADE)
function showColaboradorModal() {
console.log('showColaboradorModal: Chamado');
colaboradorModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
// Removido: colaboradorModalOverlay.style.display = 'flex';
showTab('consultarHoras'); // Define a aba inicial ao abrir o modal
console.log('showColaboradorModal: Classes do overlay:', colaboradorModalOverlay.classList);
console.log('showColaboradorModal: Current display style:', colaboradorModalOverlay.style.display); // NOVO: Log do estilo display
}

function hideColaboradorModal() {
console.log('hideColaboradorModal: Chamado');
colaboradorModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
// Removido: colaboradorModalOverlay.style.display = 'none';
hideHistoryModal(); // Garante que o modal de hist√≥rico tamb√©m esteja oculto e seus gr√°ficos destru√≠dos
console.log('hideColaboradorModal: Classes do overlay:', colaboradorModalOverlay.classList);
console.log('hideColaboradorModal: Current display style:', colaboradorModalOverlay.style.display); // NOVO: Log do estilo display
}

// NOVO: Fun√ß√µes para controlar o Modal de Hist√≥rico
function showHistoryModal() {
console.log('showHistoryModal: Chamado');
historyModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
renderCharts(); // Renderiza os gr√°ficos ao abrir o modal
console.log('showHistoryModal: Classes do overlay:', historyModalOverlay.classList);
}

function hideHistoryModal() {
console.log('hideHistoryModal: Chamado');
historyModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
// Destr√≥i as inst√¢ncias dos gr√°ficos ao fechar o modal
if (totalOvertimeChartInstance) {
    totalOvertimeChartInstance.destroy();
    totalOvertimeChartInstance = null;
}
if (positiveOvertimeChartInstance) {
    positiveOvertimeChartInstance.destroy();
    positiveOvertimeChartInstance = null;
}
console.log('hideHistoryModal: Classes do overlay:', historyModalOverlay.classList);
}

// NOVO: Fun√ß√µes para controlar o Modal de Cadastro
function showRegistrationModal(chapa) {
console.log('showRegistrationModal: Chamado para chapa', chapa);
chapaBeingProcessed = chapa; // Define a chapa que est√° sendo processada
registrationModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
regNomeCompletoInput.value = '';
regChapaInput.value = chapa; // Preenche a chapa automaticamente
regTelefoneInput.value = '';
registrationErrorMessage.classList.add('hidden');
regNomeCompletoInput.focus();
}

function hideRegistrationModal() {
console.log('hideRegistrationModal: Chamado');
registrationModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
registrationErrorMessage.classList.add('hidden');
}

// NOVO: Fun√ß√µes para controlar o Modal de Defini√ß√£o de Senha
function showPasswordSetupModal() {
console.log('showPasswordSetupModal: Chamado');
passwordSetupModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
// Limpa os campos usando os novos IDs √∫nicos
document.getElementById('setupNewPassword').value = '';
document.getElementById('setupConfirmPassword').value = '';
document.getElementById('setupSecretPhrase').value = '';
document.getElementById('setupConfirmSecretPhrase').value = '';
passwordSetupErrorMessage.classList.add('hidden');
document.getElementById('setupNewPassword').focus();
}

function hidePasswordSetupModal() {
console.log('hidePasswordSetupModal: Chamado');
passwordSetupModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
passwordSetupErrorMessage.classList.add('hidden');
}

// NOVO: Fun√ß√µes para controlar o Modal de Solicita√ß√£o de Senha
function showPasswordPromptModal(chapa) {
console.log('showPasswordPromptModal: Chamado para chapa', chapa);
chapaBeingProcessed = chapa; // Define a chapa que est√° sendo processada
passwordPromptModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
promptChapaDisplay.textContent = chapa;
promptPasswordInput.value = '';
passwordPromptErrorMessage.classList.add('hidden');
promptPasswordInput.focus();
}

function hidePasswordPromptModal() {
console.log('hidePasswordPromptModal: Chamado');
passwordPromptModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
passwordPromptErrorMessage.classList.add('hidden');
}

// NOVO: Fun√ß√µes para controlar o Modal de Recupera√ß√£o de Senha
function showForgotPasswordModal(chapa) {
console.log('showForgotPasswordModal: Chamado para chapa', chapa);
chapaBeingProcessed = chapa; // Define a chapa que est√° sendo processada
forgotPasswordModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
forgotChapaInput.value = chapa; // Preenche a chapa automaticamente
forgotTelefoneInput.value = '';
forgotSecretPhraseInput.value = ''; // NOVO: Limpa o campo da frase secreta
forgotPasswordErrorMessage.classList.add('hidden');
forgotTelefoneInput.focus();
}

function hideForgotPasswordModal() {
console.log('hideForgotPasswordModal: Chamado');
forgotPasswordModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
forgotPasswordErrorMessage.classList.add('hidden');
}

// NOVO: Fun√ß√µes para controlar o Modal de Confirma√ß√£o de Token
function showTokenConfirmationModal(chapa, pendingChanges) {
console.log('showTokenConfirmationModal: Chamado para chapa', chapa);
chapaBeingProcessed = chapa;
pendingUserDataChanges = pendingChanges; // Armazena as altera√ß√µes pendentes
tokenConfirmationModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
tokenInput.value = '';
tokenErrorMessage.classList.add('hidden');
generateAndDisplayToken(); // Gera e exibe o token
tokenInput.focus();
}

function hideTokenConfirmationModal() {
console.log('hideTokenConfirmationModal: Chamado');
tokenConfirmationModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
tokenErrorMessage.classList.add('hidden');
clearInterval(tokenTimer); // Limpa o timer
generatedToken = null;
tokenExpirationTime = null;
pendingUserDataChanges = null; // Limpa as altera√ß√µes pendentes
chapaBeingProcessed = null; // Limpa a chapa em processo
}

// NOVO: Fun√ß√£o para gerar e exibir o token
function generateAndDisplayToken() {
clearInterval(tokenTimer); // Limpa qualquer timer anterior
generatedToken = Math.floor(100000 + Math.random() * 900000).toString(); // Token de 6 d√≠gitos
tokenExpirationTime = Date.now() + (TOKEN_EXPIRATION_SECONDS * 1000); // Define o tempo de expira√ß√£o

tokenDisplay.textContent = generatedToken; // Para fins de demonstra√ß√£o
tokenInput.value = ''; // Limpa o input do token
tokenInput.disabled = false;
confirmTokenButton.disabled = false;
resendTokenButton.disabled = false;
tokenErrorMessage.classList.add('hidden');

updateTokenTimer(); // Atualiza o timer imediatamente
tokenTimer = setInterval(updateTokenTimer, 1000); // Inicia o timer
console.log('Token gerado:', generatedToken);
}

// NOVO: Fun√ß√£o para atualizar o timer do token
function updateTokenTimer() {
const remainingTime = Math.max(0, Math.floor((tokenExpirationTime - Date.now()) / 1000));
const minutes = Math.floor(remainingTime / 60);
const seconds = remainingTime % 60;
tokenTimerDisplay.textContent = `Token expira em: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

if (remainingTime <= 0) {
    clearInterval(tokenTimer);
    tokenTimerDisplay.textContent = 'Token Expirado!';
    tokenErrorMessage.textContent = 'O token expirou. Por favor, gere um novo.';
    tokenErrorMessage.classList.remove('hidden');
    tokenInput.disabled = true;
    confirmTokenButton.disabled = true;
}
}


// Fun√ß√£o para atualizar a data e hora
function updateDateTime() {
const now = new Date();
const options = {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
};
currentDateTimeDisplay.textContent = `Consulta em: ${now.toLocaleDateString('pt-BR', options)}`;
}

// NOVO: Fun√ß√£o para validar o formato de hora (HH:MM, -HH:MM, n√∫mero decimal ou string num√©rica)
function isValidTimeFormat(timeValue) {
if (typeof timeValue === 'number') {
    return true; // N√∫meros s√£o considerados v√°lidos (assumindo formato Excel de dias)
}
if (typeof timeValue === 'string') {
    // Tenta o formato HH:MM:SS ou -HH:MM:SS (ou HH:MM)
    const timeRegex = /^[+-]?(\d+):(\d{2})(:\d{2})?$/; // Added (:\d{2})? for optional seconds
    const numRegex = /^[+-]?\d+([.,]\d+)?$/; // N√∫mero simples ou decimal (com . ou ,)
    return timeRegex.test(timeValue) || numRegex.test(timeValue.replace(',', '.'));
}
return false;
}

// NOVO: Fun√ß√£o para converter HH:MM, n√∫mero decimal ou string num√©rica para minutos
function timeToMinutes(timeValue) {
if (typeof timeValue === 'number') {
    // Assume que √© um n√∫mero representando dias (formato de tempo do Excel)
    return Math.round(timeValue * 24 * 60); // Converte dias para minutos
}

if (typeof timeValue === 'string') {
    // Tenta o formato HH:MM:SS ou -HH:MM:SS (ou HH:MM)
    const timeRegex = /^[+-]?(\d+):(\d{2})(:\d{2})?$/;
    let match = timeValue.match(timeRegex);
    if (match) {
        const sign = timeValue.startsWith('-') ? -1 : 1;
        const hours = parseInt(match[1], 10);
        const minutes = parseInt(match[2], 10);
        return sign * (hours * 60 + minutes);
    }

    // Tenta string num√©rica simples (ex: "8", "1.5") interpretada como horas
    const numValue = parseFloat(timeValue.replace(',', '.')); // Lida com v√≠rgula como separador decimal
    if (!isNaN(numValue)) {
        return Math.round(numValue * 60); // Converte horas para minutos
    }
}

// Retorna 0 como fallback seguro para formatos inv√°lidos/n√£o reconhecidos
return 0;
}

// NOVO: Fun√ß√£o para converter minutos para HH:MM
function minutesToTime(totalMinutes) {
if (isNaN(totalMinutes)) return "N/A";
const sign = totalMinutes < 0 ? "-" : (totalMinutes > 0 ? "+" : ""); // Adiciona '+' para valores positivos
const absMinutes = Math.abs(totalMinutes);
const hours = Math.floor(absMinutes / 60);
const minutes = absMinutes % 60;
return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// NOVO: Fun√ß√£o para exibir os resultados da consulta do colaborador
function displayConsultationResults() {
if (!currentConsultedRecord) {
    textResults.innerHTML = '<p class="error">Nenhum registro de colaborador consultado.</p>';
    showHistoryButton.classList.add('hidden');
    return;
}

let resultHtml = '';
REQUIRED_DISPLAY_COLUMNS.forEach(col => {
    if (currentConsultedRecord.hasOwnProperty(col)) {
        let value = currentConsultedRecord[col];
        let displayValue = value;
        let className = '';
        let negativeMessage = '';

        if (col === 'Turno') { // Assumindo que 'Turno' √© o 'Saldo Final' anterior
            const minutes = timeToMinutes(value);
            if (minutes === 0 && !isValidTimeFormat(value)) { // Se n√£o conseguiu parsear e n√£o √© um formato v√°lido
                className = 'invalid-format';
                displayValue = `${value} (Formato Inv√°lido)`;
            } else {
                displayValue = minutesToTime(minutes); // Sempre exibe no formato HH:MM
                if (minutes < 0) {
                    className = 'negative-saldo';
                    negativeMessage = '<span class="negative-message">(Horas Negativas)</span>';
                }
            }
        }
        resultHtml += `<p><strong>${col}:</strong> <span class="${className}">${displayValue}</span>${negativeMessage}</p>`;
    } else {
        resultHtml += `<p class="error"><strong>${col}:</strong> Dado n√£o dispon√≠vel para esta chapa.</p>`;
    }
});
textResults.innerHTML = resultHtml;

const employeeChapa = String(currentConsultedRecord.CHAPA);
// O bot√£o de hist√≥rico aparece se houver 1 ou mais pontos
if (employeeHistory[employeeChapa] && employeeHistory[employeeChapa].length > 0) {
    showHistoryButton.classList.remove('hidden');
    console.log('displayConsultationResults: showHistoryButton vis√≠vel.');
} else {
    showHistoryButton.classList.add('hidden');
    console.log('displayConsultationResults: showHistoryButton oculto.');
}
showColaboradorModal(); // Reabre o modal principal do colaborador com os resultados
}


// NOVO: Fun√ß√£o para renderizar o gr√°fico de horas por l√≠der
function renderLeaderOvertimeChart(dataToChart) {
console.log('renderLeaderOvertimeChart: Chamado');
const data = dataToChart || overtimeData; // Usa os dados passados ou os dados globais

if (data.length === 0) {
    console.log('renderLeaderOvertimeChart: Sem dados para renderizar o gr√°fico de l√≠deres.');
    if (leaderOvertimeChartInstance) {
        leaderOvertimeChartInstance.destroy();
        leaderOvertimeChartInstance = null;
    }
    return;
}

const leaderSummary = {}; // { "L√≠der A": { positive: N, negative: M }, ... }

data.forEach(record => { // Usa 'data' em vez de 'overtimeData'
    const leader = record.L√≠der;
    if (!leader) return; // Ignora registros sem l√≠der

    if (!leaderSummary[leader]) {
        leaderSummary[leader] = { positive: 0, negative: 0 };
    }

    const saldoMinutes = timeToMinutes(record['Turno']); // Usando 'Turno' como Saldo Final
    if (saldoMinutes > 0) {
        leaderSummary[leader].positive += saldoMinutes;
    } else {
        leaderSummary[leader].negative += Math.abs(saldoMinutes); // Soma o valor absoluto das horas negativas
    }
});

const leaders = Object.keys(leaderSummary);
const positiveHours = leaders.map(leader => leaderSummary[leader].positive);
const negativeHours = leaders.map(leader => leaderSummary[leader].negative);

const ctx = leaderOvertimeChartCanvas.getContext('2d');

if (leaderOvertimeChartInstance) {
    leaderOvertimeChartInstance.destroy();
}

leaderOvertimeChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: leaders,
        datasets: [
            {
                label: 'Horas Positivas',
                data: positiveHours,
                backgroundColor: 'rgba(46, 204, 113, 0.7)', // Verde para positivo
                borderColor: 'rgba(39, 174, 96, 1)',
                borderWidth: 1
            },
            {
                label: 'Horas Negativas',
                data: negativeHours,
                backgroundColor: 'rgba(231, 76, 60, 0.7)', // Vermelho para negativo
                borderColor: 'rgba(192, 57, 43, 1)',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const valueInMinutes = context.raw;
                        return `${context.dataset.label}: ${minutesToTime(valueInMinutes)}`;
                    }
                }
            },
            legend: {
                position: 'top',
            },
            datalabels: {
                color: 'white',
                font: {
                    weight: 'bold',
                    size: 10
                },
                formatter: function(value) {
                    return minutesToTime(value);
                },
                align: 'center',
                anchor: 'center'
            }
        },
        scales: {
            x: {
                stacked: false, // Barras lado a lado
                title: {
                    display: true,
                    text: 'L√≠der'
                }
            },
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Horas (HH:MM)'
                },
                ticks: {
                    callback: function(value) {
                        return minutesToTime(value);
                    }
                }
            }
        }
    }
});
console.log('renderLeaderOvertimeChart: Gr√°fico de l√≠deres renderizado.');
}


// NOVO: Fun√ß√£o para renderizar os gr√°ficos (Hist√≥rico do Colaborador)
function renderCharts() {
console.log('renderCharts: Chamado');
if (!currentConsultedRecord) {
    console.error("Nenhum registro de colaborador consultado para gerar gr√°ficos.");
    return;
}

const employeeChapa = String(currentConsultedRecord.CHAPA);
const history = employeeHistory[employeeChapa];

if (!history || history.length === 0) { // Se n√£o h√° hist√≥rico ou est√° vazio
    totalOvertimeChartTitle.textContent = `Hist√≥rico de Saldo Total de Horas de ${currentConsultedRecord.Nome}`;
    positiveOvertimeChartTitle.textContent = `Hist√≥rico de Horas Positivas de ${currentConsultedRecord.Nome}`;
    totalPercentageChangeDisplay.textContent = 'N√£o h√° dados hist√≥ricos para exibir.';
    positivePercentageChangeDisplay.textContent = 'N√£o h√° dados hist√≥ricos para exibir.';
    
    // Destr√≥i gr√°ficos existentes para limpar a √°rea
    if (totalOvertimeChartInstance) {
        totalOvertimeChartInstance.destroy();
        totalOvertimeChartInstance = null;
    }
    if (positiveOvertimeChartInstance) {
        positiveOvertimeChartInstance.destroy();
        positiveOvertimeChartInstance = null;
    }
    return;
}

// Ordena o hist√≥rico por data para garantir a ordem correta no gr√°fico
history.sort((a, b) => new Date(a.date) - new Date(b.date));

const employeeName = currentConsultedRecord.Nome;
totalOvertimeChartTitle.textContent = `Saldo Total de Horas de ${employeeName}`;
positiveOvertimeChartTitle.textContent = `Horas Positivas de ${employeeName}`;

const chartLabels = history.map(entry => {
    const date = new Date(entry.date);
    return date.toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' });
});
const totalChartData = history.map(entry => entry.totalMinutes);
const positiveChartData = history.map(entry => entry.positiveMinutes);

// Calcula a varia√ß√£o percentual para o Saldo Total
let totalPercentageMessage = '';
totalPercentageChangeDisplay.classList.remove('positive', 'negative');
if (history.length < 2) {
    totalPercentageChangeDisplay.textContent = 'Apenas um ponto de dados dispon√≠vel. N√£o √© poss√≠vel calcular a evolu√ß√£o.';
} else {
    const firstTotalMinutes = totalChartData[0];
    const lastTotalMinutes = totalChartData[totalChartData.length - 1];
    if (firstTotalMinutes !== 0) {
        const percentageChange = ((lastTotalMinutes - firstTotalMinutes) / Math.abs(firstTotalMinutes)) * 100;
        totalPercentageMessage = `Varia√ß√£o no per√≠odo: ${percentageChange.toFixed(2)}%`;
        if (percentageChange > 0) {
            totalPercentageChangeDisplay.classList.add('positive');
            totalPercentageMessage = `üìà ${totalPercentageMessage} (Aumento)`;
        } else if (percentageChange < 0) {
            totalPercentageChangeDisplay.classList.add('negative');
            totalPercentageMessage = `üìâ ${totalPercentageMessage} (Redu√ß√£o)`;
        } else {
            totalPercentageMessage = `‚ÜîÔ∏è ${totalPercentageMessage} (Est√°vel)`;
        }
    } else {
        totalPercentageMessage = `Varia√ß√£o no per√≠odo: N√£o calcul√°vel (saldo inicial zero).`;
    }
    totalPercentageChangeDisplay.textContent = totalPercentageMessage;
}

// Calcula a varia√ß√£o percentual para Horas Positivas
let positivePercentageMessage = '';
positivePercentageChangeDisplay.classList.remove('positive', 'negative');
if (history.length < 2) {
    positivePercentageChangeDisplay.textContent = 'Apenas um ponto de dados dispon√≠vel. N√£o √© poss√≠vel calcular a evolu√ß√£o.';
} else {
    const firstPositiveMinutes = positiveChartData[0];
    const lastPositiveMinutes = positiveChartData[positiveChartData.length - 1];
    if (firstPositiveMinutes !== 0) {
        const percentageChange = ((lastPositiveMinutes - firstPositiveMinutes) / Math.abs(firstPositiveMinutes)) * 100;
        positivePercentageMessage = `Varia√ß√£o no per√≠odo: ${percentageChange.toFixed(2)}%`;
        if (percentageChange > 0) {
            positivePercentageChangeDisplay.classList.add('positive');
            positivePercentageMessage = `üìà ${positivePercentageMessage} (Aumento)`;
        } else if (percentageChange < 0) {
            positivePercentageChangeDisplay.classList.add('negative');
            positivePercentageMessage = `üìâ ${positivePercentageMessage} (Redu√ß√£o)`;
        } else {
            positivePercentageMessage = `‚ÜîÔ∏è ${positivePercentageMessage} (Est√°vel)`;
        }
    } else {
        positivePercentageMessage = `Varia√ß√£o no per√≠odo: N√£o calcul√°vel (horas positivas iniciais zero).`;
    }
    positivePercentageChangeDisplay.textContent = positivePercentageMessage;
}


// Renderiza o Gr√°fico de Linha (Saldo Total)
const totalCtx = document.getElementById('totalOvertimeChart').getContext('2d');
// Destr√≥i a inst√¢ncia anterior do gr√°fico se existir
if (totalOvertimeChartInstance) {
    totalOvertimeChartInstance.destroy();
}
totalOvertimeChartInstance = new Chart(totalCtx, {
    type: 'line',
    data: {
        labels: chartLabels,
        datasets: [{
            label: 'Saldo Total de Horas',
            data: totalChartData,
            borderColor: (context) => {
                const chart = context;
                const { ctx, chartArea } = chart;
                if (!chartArea) return;
                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                gradient.addColorStop(0, 'red'); // Valores negativos
                gradient.addColorStop(0.5, 'orange'); // Valores pr√≥ximos de zero
                gradient.addColorStop(1, 'green'); // Valores positivos
                return gradient;
            },
            backgroundColor: 'rgba(74, 144, 226, 0.2)',
            fill: true,
            tension: 0.3,
            pointBackgroundColor: (context) => {
                const value = context.raw;
                if (value < 0) return 'red';
                if (value === 0) return 'orange';
                return 'green';
            },
            pointBorderColor: (context) => {
                const value = context.raw;
                if (value < 0) return 'darkred';
                if (value === 0) return 'darkorange';
                return 'darkgreen';
            },
            pointRadius: 5,
            pointHoverRadius: 7,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, // Mant√©m false para preencher o wrapper
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const valueInMinutes = context.raw;
                        return `Saldo: ${minutesToTime(valueInMinutes)}`;
                    }
                }
            },
            legend: { display: false },
            datalabels: { // NOVO: Configura√ß√£o do plugin datalabels
                color: '#34495e', // Cor do texto (var(--text-dark))
                font: {
                    weight: 'bold',
                    size: 10
                },
                formatter: function(value) {
                    return minutesToTime(value);
                },
                align: 'end', // Alinha o r√≥tulo ao final do ponto
                anchor: 'end' // Ancoragem no final do ponto
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                title: { display: true, text: 'Horas (HH:MM)' },
                ticks: {
                    callback: function(value) { return minutesToTime(value); }
                }
            },
            x: {
                title: { display: true, text: 'Data' }
            }
        }
    }
});

// Renderiza o Gr√°fico de Barras (Horas Positivas)
const positiveCtx = document.getElementById('positiveOvertimeChart').getContext('2d');
// Destr√≥i a inst√¢ncia anterior do gr√°fico se existir
if (positiveOvertimeChartInstance) {
    positiveOvertimeChartInstance.destroy();
}
positiveOvertimeChartInstance = new Chart(positiveCtx, {
    type: 'bar',
    data: {
        labels: chartLabels,
        datasets: [{
            label: 'Horas Positivas',
            data: positiveChartData,
            backgroundColor: 'rgba(46, 204, 113, 0.7)', // Verde para horas positivas
            borderColor: 'rgba(39, 174, 96, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const valueInMinutes = context.raw;
                        return `Horas: ${minutesToTime(valueInMinutes)}`;
                    }
                }
            },
            legend: { display: false },
            datalabels: { // NOVO: Configura√ß√£o do plugin datalabels
                color: 'white', // Cor do texto para contraste com a barra
                font: {
                    weight: 'bold',
                    size: 10
                },
                formatter: function(value) {
                    return minutesToTime(value);
                },
                align: 'center', // Alinha o r√≥tulo no centro da barra
                anchor: 'center' // Ancoragem no centro da barra
            }
        }
    },
    scales: {
        y: {
            beginAtZero: true, // Horas positivas sempre come√ßam em zero
            title: { display: true, text: 'Horas (HH:MM)' },
            ticks: {
                callback: function(value) { return minutesToTime(value); }
            }
        },
        x: {
            title: { display: true, text: 'Data' }
        }
    }
});
}

// NOVO: Fun√ß√£o para exibir registros na tabela e atualizar o gr√°fico de l√≠deres
function displayRecordsAndChart(dataToDisplay, titlePrefix) {
allRecordsTable.innerHTML = ''; // Limpa o conte√∫do do wrapper da tabela
tableTitle.textContent = ''; // Limpa o t√≠tulo
recordsCount.textContent = ''; // Limpa a contagem

if (dataToDisplay.length === 0) {
    allRecordsTable.innerHTML = '<p class="no-data-message">Nenhum registro encontrado para esta consulta.</p>';
    tableTitle.textContent = `${titlePrefix} (0 registros)`;
    recordsCount.textContent = '';
    renderLeaderOvertimeChart([]); // Renderiza o gr√°fico vazio
    return;
}

tableTitle.textContent = `${titlePrefix} (${dataToDisplay.length} registros)`;
recordsCount.textContent = ''; // A contagem j√° est√° no t√≠tulo

const table = document.createElement('table');
const thead = document.createElement('thead');
const tbody = document.createElement('tbody');

const headerRow = document.createElement('tr');
REQUIRED_DISPLAY_COLUMNS.forEach(headerText => {
    const th = document.createElement('th');
    th.textContent = headerText;
    headerRow.appendChild(th);
});
thead.appendChild(headerRow);
table.appendChild(thead);

dataToDisplay.forEach(record => {
    const row = document.createElement('tr');
    REQUIRED_DISPLAY_COLUMNS.forEach(col => {
        const td = document.createElement('td');
        let value = record.hasOwnProperty(col) ? record[col] : 'N/A';
        if (col === 'Turno') { // Usando 'Turno' como Saldo Final
            const minutes = timeToMinutes(value);
            if (minutes === 0 && !isValidTimeFormat(value)) {
                td.classList.add('invalid-format');
                value = `${value} (Formato Inv√°lido)`;
            } else {
                value = minutesToTime(minutes);
                if (minutes < 0) {
                    td.classList.add('negative-saldo');
                }
            }
        }
        td.textContent = value;
        row.appendChild(td);
    });
    tbody.appendChild(row);
});
table.appendChild(tbody);
allRecordsTable.appendChild(table); // Adiciona a tabela ao wrapper responsivo

renderLeaderOvertimeChart(dataToDisplay); // Desenha o gr√°fico com os dados exibidos na tabela
}


// NOVO: Fun√ß√£o para gerar o relat√≥rio PDF (geral)
async function generatePdfReport() {
console.log('generatePdfReport: Iniciando gera√ß√£o do relat√≥rio geral...');
if (overtimeData.length === 0) {
    alert('Nenhum dado carregado para gerar o relat√≥rio PDF.');
    console.warn('generatePdfReport: Nenhum dado carregado.');
    return;
}

printPdfButton.disabled = true;
pdfSpinner.classList.remove('hidden'); // Mostra o spinner

try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    console.log('generatePdfReport: jsPDF instance created.');

    // Margens padr√£o para o documento
    const margin = 15;
    let yOffset = margin;
    const pageWidth = doc.internal.pageSize.getWidth();

    // Adicionar Logotipo
    const logoWidth = 50; // mm
    const logoHeight = 12.5; // mm
    const logoX = (pageWidth - logoWidth) / 2; // Centraliza o logo
    const logoY = 10; // 10mm do topo
    
    const svgBase64 = LOGO_BASE64_SVG.split(',')[1];
    const svgString = atob(svgBase64);

    try {
        doc.addSvg(svgString, logoX, logoY, logoWidth, logoHeight);
        console.log('generatePdfReport: SVG logo added successfully.');
    } catch (svgError) {
        console.error('generatePdfReport: Erro ao adicionar SVG logo ao PDF:', svgError);
        doc.setFontSize(16);
        doc.text('Banco Horas B+', logoX, logoY + logoHeight / 2, { align: 'center', baseline: 'middle' });
    }

    yOffset = logoY + logoHeight + 15; // Come√ßa o conte√∫do ap√≥s o logo + margem

    // T√≠tulo Principal
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.text('Relat√≥rio Completo de Horas Extras', pageWidth / 2, yOffset, { align: 'center' });
    yOffset += 10;

    // Data de Gera√ß√£o
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, pageWidth / 2, yOffset, { align: 'center' });
    yOffset += 20; // Espa√ßo ap√≥s a data de gera√ß√£o

    // Resumo de Saldo de Horas por L√≠der (usando autoTable para melhor organiza√ß√£o)
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('Saldo de Horas por L√≠der', margin, yOffset);
    yOffset += 10;

    const leaderSummary = {};
    overtimeData.forEach(record => {
        const leader = record.L√≠der;
        if (!leader) return;
        if (!leaderSummary[leader]) {
            leaderSummary[leader] = { positive: 0, negative: 0 };
        }
        const saldoMinutes = timeToMinutes(record['Turno']); // Usando 'Turno' como Saldo Final
        if (saldoMinutes > 0) {
            leaderSummary[leader].positive += saldoMinutes;
        } else {
            leaderSummary[leader].negative += Math.abs(saldoMinutes);
        }
    });

    const leaderTableHeaders = [['L√≠der', 'Horas Positivas', 'Horas Negativas']];
    const leaderTableData = Object.keys(leaderSummary).map(leader => [
        leader,
        minutesToTime(leaderSummary[leader].positive),
        minutesToTime(leaderSummary[leader].negative)
    ]);

    doc.autoTable({
        startY: yOffset,
        head: leaderTableHeaders,
        body: leaderTableData,
        theme: 'grid', // Usar 'grid' para bordas vis√≠veis
        styles: {
            fontSize: 10,
            cellPadding: 3,
            valign: 'middle',
            overflow: 'linebreak',
            lineColor: [220, 230, 237], // Cor da borda da c√©lula
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [74, 144, 226], // Cor de fundo do cabe√ßalho (primary-color)
            textColor: [255, 255, 255], // Texto branco
            fontStyle: 'bold',
            halign: 'center'
        },
        bodyStyles: {
            textColor: [52, 73, 94] // Cor do texto do corpo
        },
        columnStyles: {
            0: { cellWidth: 'auto' },
            1: { halign: 'center' },
            2: { halign: 'center' }
        },
        margin: { left: margin, right: margin }
    });
    yOffset = doc.autoTable.previous.finalY + 20; // Atualiza yOffset ap√≥s a tabela de l√≠deres

    // Tabela de Todos os Registros
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('Todos os Registros de Horas Extras', margin, yOffset);
    yOffset += 10;

    const tableHeaders = REQUIRED_DISPLAY_COLUMNS;
    const tableData = overtimeData.map(record => {
        return REQUIRED_DISPLAY_COLUMNS.map(col => {
            let value = record.hasOwnProperty(col) ? record[col] : 'N/A';
            if (col === 'Turno') { // Usando 'Turno' como Saldo Final
                const minutes = timeToMinutes(value);
                if (minutes === 0 && !isValidTimeFormat(value)) {
                    return `${value} (Formato Inv√°lido)`;
                } else {
                    return minutesToTime(minutes);
                }
            }
            return String(value);
        });
    });

    doc.autoTable({
        startY: yOffset,
        head: [tableHeaders],
        body: tableData,
        theme: 'striped',
        styles: {
            fontSize: 8,
            cellPadding: 2,
            valign: 'middle',
            overflow: 'linebreak',
            lineColor: [220, 230, 237], // Cor da borda da c√©lula
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [242, 244, 247], // #f2f4f7
            textColor: [52, 73, 94], // #34495e
            fontStyle: 'bold'
        },
        columnStyles: {
            'Turno': { cellWidth: 25 } // Ajusta largura para Turno
        },
        margin: { left: margin, right: margin },
        didDrawPage: function (data) {
            // Footer
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            let str = "P√°gina " + doc.internal.getNumberOfPages();
            doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
    });

    doc.output('dataurlnewwindow');
    console.log('generatePdfReport: PDF gerado e aberto em nova janela.');

} catch (error) {
    console.error('generatePdfReport: Erro ao gerar PDF:', error);
    alert(`Erro ao gerar relat√≥rio PDF: ${error.message}. Verifique o console para mais detalhes.`);
} finally {
    printPdfButton.disabled = false;
    pdfSpinner.classList.add('hidden'); // Esconde o spinner
    console.log('generatePdfReport: Finalizado.');
}
}

// NOVO: Fun√ß√£o central para criar o documento PDF para um colaborador espec√≠fico
async function createPdfDocument(collaboratorRecord, phoneNumber = null) {
console.log('createPdfDocument: Iniciando cria√ß√£o do documento PDF para', collaboratorRecord.Nome);
const { jsPDF } = window.jspdf; // Acessa jsPDF da janela global
const doc = new jsPDF();
console.log('createPdfDocument: jsPDF instance created.');

// Margens padr√£o para o documento
const margin = 15;
let yOffset = margin;
const pageWidth = doc.internal.pageSize.getWidth();

// Adicionar Logotipo
const logoWidth = 50; // mm
const logoHeight = 12.5; // mm
const logoX = (pageWidth - logoWidth) / 2; // Centraliza o logo
const logoY = 10; // 10mm do topo

const svgBase64 = LOGO_BASE64_SVG.split(',')[1];
const svgString = atob(svgBase64);

try {
    doc.addSvg(svgString, logoX, logoY, logoWidth, logoHeight);
    console.log('createPdfDocument: SVG logo added successfully.');
} catch (svgError) {
    console.error('createPdfDocument: Erro ao adicionar SVG logo ao PDF:', svgError);
    doc.setFontSize(16);
    doc.text('Banco Horas B+', logoX, logoY + logoHeight / 2, { align: 'center', baseline: 'middle' });
}

yOffset = logoY + logoHeight + 15; // Come√ßa o conte√∫do ap√≥s o logo + margem

// T√≠tulo Principal
doc.setFontSize(24);
doc.setFont('helvetica', 'bold');
doc.text('Relat√≥rio de Horas Extras', pageWidth / 2, yOffset, { align: 'center' });
yOffset += 10; // Espa√ßo entre o t√≠tulo principal e o nome do colaborador

// Nome do Colaborador (como subt√≠tulo)
doc.setFontSize(18); // Tamanho de fonte um pouco menor para o nome
doc.setFont('helvetica', 'normal'); // Fonte normal para o nome
doc.text(collaboratorRecord.Nome, pageWidth / 2, yOffset, { align: 'center' });
yOffset += 10; // Espa√ßo ap√≥s o nome do colaborador

// Data de Gera√ß√£o
doc.setFontSize(10);
doc.setFont('helvetica', 'normal');
doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, pageWidth / 2, yOffset, { align: 'center' });
yOffset += 20;

// Detalhes do Colaborador
doc.setFontSize(16);
doc.setFont('helvetica', 'bold');
doc.text('Dados do Colaborador:', margin, yOffset);
yOffset += 8;
doc.setFontSize(12);
doc.setFont('helvetica', 'normal');
doc.text(`Chapa: ${collaboratorRecord.CHAPA}`, margin, yOffset);
yOffset += 7;
doc.text(`Nome: ${collaboratorRecord.Nome}`, margin, yOffset);
yOffset += 7;
doc.text(`Fun√ß√£o: ${collaboratorRecord.Fun√ß√£o}`, margin, yOffset); // Usando 'Fun√ß√£o'
yOffset += 7;
doc.text(`L√≠der: ${collaboratorRecord.L√≠der}`, margin, yOffset);
yOffset += 7;

if (phoneNumber) {
    doc.text(`Telefone: ${phoneNumber}`, margin, yOffset);
    yOffset += 7;
}
yOffset += 15;

// Saldo Atual
doc.setFontSize(16);
doc.setFont('helvetica', 'bold');
doc.text('Saldo Atual de Horas:', margin, yOffset);
yOffset += 8;
doc.setFontSize(18); // Saldo maior
doc.setFont('helvetica', 'bold');
const saldoFinalMinutes = timeToMinutes(collaboratorRecord['Turno']); // Usando 'Turno' como Saldo Final
const saldoFinalDisplay = minutesToTime(saldoFinalMinutes);
doc.text(`Saldo Final: ${saldoFinalDisplay}`, margin, yOffset);
if (saldoFinalMinutes < 0) {
    doc.setTextColor(231, 76, 60); // Vermelho
    doc.setFontSize(12); // Texto menor para a mensagem
    doc.text('(Horas Negativas)', margin + doc.getTextWidth(`Saldo Final: ${saldoFinalDisplay} `), yOffset);
    doc.setTextColor(52, 73, 94); // Volta para a cor padr√£o
}
yOffset += 15; // Espa√ßo ap√≥s o saldo

// Hist√≥rico de Evolu√ß√£o
const history = employeeHistory[String(collaboratorRecord.CHAPA)];
if (history && history.length > 0) {
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('Hist√≥rico de Evolu√ß√£o:', margin, yOffset);
    yOffset += 8;

    const historyHeaders = [['Data', 'Saldo Total', 'Horas Positivas']];
    const historyData = history.map(entry => [
        new Date(entry.date).toLocaleDateString('pt-BR'),
        minutesToTime(entry.totalMinutes),
        minutesToTime(entry.positiveMinutes)
    ]);

    doc.autoTable({
        startY: yOffset,
        head: historyHeaders,
        body: historyData,
        theme: 'striped',
        styles: {
            fontSize: 8,
            cellPadding: 2,
            valign: 'middle',
            overflow: 'linebreak',
            lineColor: [220, 230, 237],
            lineWidth: 0.1
        },
        headStyles: {
            fillColor: [74, 144, 226], // Cor de fundo do cabe√ßalho (primary-color)
            textColor: [255, 255, 255], // Texto branco
            fontStyle: 'bold',
            halign: 'center'
        },
        bodyStyles: {
            textColor: [52, 73, 94]
        },
        columnStyles: {
            0: { halign: 'center' },
            1: { halign: 'center' },
            2: { halign: 'center' }
        },
        margin: { left: margin, right: margin },
        didDrawPage: function (data) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            let str = "P√°gina " + doc.internal.getNumberOfPages();
            doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
    });
} else {
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text('N√£o h√° hist√≥rico de evolu√ß√£o dispon√≠vel para este colaborador.', margin, yOffset);
    yOffset += 10;
}
console.log('createPdfDocument: Documento PDF criado com sucesso.');
return doc;
}


// NOVO: Fun√ß√£o para lidar com o download do PDF espec√≠fico
async function handleDownloadSpecificPdfReport() {
console.log('handleDownloadSpecificPdfReport: Clicado');
const chapa = chapaWhatsappInput.value.trim();
whatsappStatusMessage.classList.add('hidden');
downloadPdfSpinner.classList.remove('hidden');
downloadSpecificPdfButton.disabled = true;
sendWhatsappButton.disabled = true;

if (overtimeData.length === 0) {
    whatsappStatusMessage.textContent = 'Nenhum dado carregado. Por favor, carregue um arquivo Excel primeiro.';
    whatsappStatusMessage.className = 'error';
    whatsappStatusMessage.classList.remove('hidden');
    console.log('handleDownloadSpecificPdfReport: Erro - Nenhum dado carregado.');
    downloadPdfSpinner.classList.add('hidden');
    downloadSpecificPdfButton.disabled = false;
    sendWhatsappButton.disabled = false;
    return;
}

if (!chapa) {
    whatsappStatusMessage.textContent = 'Por favor, digite a chapa do colaborador para baixar o relat√≥rio.';
    whatsappStatusMessage.className = 'error';
    whatsappStatusMessage.classList.remove('hidden');
    console.log('handleDownloadSpecificPdfReport: Erro - Chapa vazia.');
    downloadPdfSpinner.classList.add('hidden');
    downloadSpecificPdfButton.disabled = false;
    sendWhatsappButton.disabled = false;
    return;
}

const foundRecord = overtimeData.find(record => String(record.CHAPA) === chapa);
console.log('handleDownloadSpecificPdfReport: Registro encontrado para chapa', chapa, ':', foundRecord);

if (foundRecord) {
    try {
        whatsappStatusMessage.textContent = 'Gerando relat√≥rio PDF para download...';
        whatsappStatusMessage.className = '';
        whatsappStatusMessage.classList.remove('hidden');

        const userData = registeredUsers[chapa];
        const phoneNumber = userData ? userData.telefone : null; // Pega o telefone cadastrado se existir

        const doc = await createPdfDocument(foundRecord, phoneNumber);
        const fileName = `Relatorio_Horas_Extras_${foundRecord.Nome.replace(/\s/g, '_')}_${foundRecord.CHAPA}.pdf`;
        doc.save(fileName); // Isso dispara o download do PDF
        console.log('handleDownloadSpecificPdfReport: PDF salvo como', fileName);

        whatsappStatusMessage.textContent = 'Relat√≥rio PDF gerado e baixado com sucesso!';
        whatsappStatusMessage.className = 'success';
        whatsappStatusMessage.classList.remove('hidden');

    } catch (error) {
        console.error('handleDownloadSpecificPdfReport: Erro ao gerar PDF para download:', error);
        whatsappStatusMessage.textContent = `Erro ao gerar relat√≥rio PDF: ${error.message}. Verifique o console para mais detalhes.`;
        whatsappStatusMessage.className = 'error';
        whatsappStatusMessage.classList.remove('hidden');
    } finally {
        downloadPdfSpinner.classList.add('hidden');
        downloadSpecificPdfButton.disabled = false;
        sendWhatsappButton.disabled = false;
        console.log('handleDownloadSpecificPdfReport: Finalizado.');
    }
} else {
    whatsappStatusMessage.textContent = `Chapa "${chapa}" n√£o encontrada nos dados carregados.`;
    whatsappStatusMessage.className = 'error';
    whatsappStatusMessage.classList.remove('hidden');
    console.log('handleDownloadSpecificPdfReport: Erro - Chapa n√£o encontrada nos dados do Excel.');
    downloadPdfSpinner.classList.add('hidden');
    downloadSpecificPdfButton.disabled = false;
    sendWhatsappButton.disabled = false;
}
}


// NOVO: Fun√ß√£o para lidar com o envio do relat√≥rio via WhatsApp
async function handleSendWhatsappReport() {
console.log('handleSendWhatsappReport: Clicado');
const chapa = chapaWhatsappInput.value.trim();
const manualPhoneNumber = whatsappPhoneNumberInput.value.trim();
whatsappStatusMessage.classList.add('hidden');
whatsappSpinner.classList.remove('hidden');
sendWhatsappButton.disabled = true;
downloadSpecificPdfButton.disabled = true;

if (overtimeData.length === 0) {
    whatsappStatusMessage.textContent = 'Nenhum dado carregado. Por favor, carregue um arquivo Excel primeiro.';
    whatsappStatusMessage.className = 'error';
    whatsappStatusMessage.classList.remove('hidden');
    console.log('handleSendWhatsappReport: Erro - Nenhum dado carregado.');
    whatsappSpinner.classList.add('hidden');
    sendWhatsappButton.disabled = false;
    downloadSpecificPdfButton.disabled = false;
    return;
}

if (!chapa) {
    whatsappStatusMessage.textContent = 'Por favor, digite a chapa do colaborador.';
    whatsappStatusMessage.className = 'error';
    whatsappStatusMessage.classList.remove('hidden');
    console.log('handleSendWhatsappReport: Erro - Chapa vazia.');
    whatsappSpinner.classList.add('hidden');
    sendWhatsappButton.disabled = false;
    downloadSpecificPdfButton.disabled = false;
    return;
}

const foundRecord = overtimeData.find(record => String(record.CHAPA) === chapa);
console.log('handleSendWhatsappReport: Registro encontrado para chapa', chapa, ':', foundRecord);

if (foundRecord) {
    const userData = registeredUsers[chapa];
    let phoneNumberToSend = '';

    if (userData && userData.telefone) {
        phoneNumberToSend = userData.telefone; // Prioriza o telefone cadastrado
        console.log('handleSendWhatsappReport: Usando telefone cadastrado:', phoneNumberToSend);
    } else if (manualPhoneNumber) {
        phoneNumberToSend = manualPhoneNumber; // Usa o telefone manual se n√£o houver cadastrado
        console.log('handleSendWhatsappReport: Usando telefone manual:', phoneNumberToSend);
    } else {
        whatsappStatusMessage.textContent = `Telefone n√£o cadastrado para a chapa ${chapa} e nenhum telefone manual foi fornecido. N√£o √© poss√≠vel enviar via WhatsApp.`;
        whatsappStatusMessage.className = 'error';
        whatsappStatusMessage.classList.remove('hidden');
        console.log('handleSendWhatsappReport: Erro - Telefone n√£o dispon√≠vel.');
        whatsappSpinner.classList.add('hidden');
        sendWhatsappButton.disabled = false;
        downloadSpecificPdfButton.disabled = false;
        return;
    }
    
    try {
        whatsappStatusMessage.textContent = 'Gerando relat√≥rio PDF e abrindo WhatsApp...';
        whatsappStatusMessage.className = '';
        whatsappStatusMessage.classList.remove('hidden');

        const doc = await createPdfDocument(foundRecord, phoneNumberToSend);
        const fileName = `Relatorio_Horas_Extras_${foundRecord.Nome.replace(/\s/g, '_')}_${foundRecord.CHAPA}.pdf`;
        doc.save(fileName); // Isso dispara o download do PDF
        console.log('handleSendWhatsappReport: PDF salvo como', fileName);

        const whatsappMessage = encodeURIComponent(`Ol√° ${foundRecord.Nome}, segue seu relat√≥rio de horas extras. Por favor, anexe o arquivo PDF que foi baixado.`);
        const cleanedPhoneNumber = phoneNumberToSend.replace(/\D/g, ''); // Limpa o n√∫mero
        const whatsappUrl = `https://wa.me/${cleanedPhoneNumber}?text=${whatsappMessage}`;
        console.log('handleSendWhatsappReport: Abrindo WhatsApp URL:', whatsappUrl);
        window.open(whatsappUrl, '_blank');

        whatsappStatusMessage.textContent = 'Relat√≥rio PDF gerado e baixado. Abrindo WhatsApp. Lembre-se de anexar o PDF manualmente no WhatsApp.';
        whatsappStatusMessage.className = 'success';
        whatsappStatusMessage.classList.remove('hidden');

    } catch (error) {
        console.error('handleSendWhatsappReport: Erro ao gerar PDF ou abrir WhatsApp:', error);
        whatsappStatusMessage.textContent = `Erro ao gerar relat√≥rio ou abrir WhatsApp: ${error.message}. Verifique o console para mais detalhes.`;
        whatsappStatusMessage.className = 'error';
        whatsappStatusMessage.classList.remove('hidden');
    } finally {
        whatsappSpinner.classList.add('hidden');
        sendWhatsappButton.disabled = false;
        downloadSpecificPdfButton.disabled = false;
        console.log('handleSendWhatsappReport: Finalizado.');
    }

} else {
    whatsappStatusMessage.textContent = `Chapa "${chapa}" n√£o encontrada nos dados carregados.`;
    whatsappStatusMessage.className = 'error';
    whatsappStatusMessage.classList.remove('hidden');
    console.log('handleSendWhatsappReport: Erro - Chapa n√£o encontrada nos dados do Excel.');
    whatsappSpinner.classList.add('hidden');
    sendWhatsappButton.disabled = false;
    downloadSpecificPdfButton.disabled = false;
}
}


// Event Listeners para o Modal Admin de Login
adminIcon.addEventListener('click', () => {
console.log('adminIcon: Clicado');
showAdminModal();
});
closeAdminModalButton.addEventListener('click', () => {
console.log('closeAdminModalButton: Clicado');
hideAdminModal();
});
adminModalOverlay.addEventListener('click', (e) => {
if (e.target === adminModalOverlay) {
    console.log('adminModalOverlay: Clicado no overlay');
    hideAdminModal();
}
});

adminLoginButton.addEventListener('click', () => {
console.log('adminLoginButton: Clicado');
const enteredPassword = adminPasswordInput.value;
if (enteredPassword === ADMIN_PASSWORD) {
    hideAdminModal(); // Esconde o modal de senha
    showAdminContentModal(); // Mostra o novo modal de conte√∫do do administrador
    modalErrorMessage.classList.add('hidden');
} else {
    modalErrorMessage.textContent = 'Senha incorreta. Tente novamente.';
    modalErrorMessage.classList.remove('hidden');
    adminPasswordInput.value = '';
}
});

// NOVO: Event Listeners para o Modal de Conte√∫do do Administrador
closeAdminContentModalButton.addEventListener('click', () => {
console.log('closeAdminContentModalButton: Clicado');
hideAdminContentModal();
});
adminContentModalOverlay.addEventListener('click', (e) => {
if (e.target === adminContentModalOverlay) {
    console.log('adminContentModalOverlay: Clicado no overlay');
    hideAdminContentModal();
}
});

// Fun√ß√µes para controlar o modal Colaborador (AGORA APENAS VISIBILIDADE)
function showColaboradorModal() {
console.log('showColaboradorModal: Chamado');
colaboradorModalOverlay.classList.add('visible'); // Apenas adiciona 'visible'
// Removido: colaboradorModalOverlay.style.display = 'flex';
showTab('consultarHoras'); // Define a aba inicial ao abrir o modal
console.log('showColaboradorModal: Classes do overlay:', colaboradorModalOverlay.classList);
console.log('showColaboradorModal: Current display style:', colaboradorModalOverlay.style.display); // NOVO: Log do estilo display
}

function hideColaboradorModal() {
console.log('hideColaboradorModal: Chamado');
colaboradorModalOverlay.classList.remove('visible'); // Apenas remove 'visible'
// Removido: colaboradorModalOverlay.style.display = 'none';
hideHistoryModal(); // Garante que o modal de hist√≥rico tamb√©m esteja oculto e seus gr√°ficos destru√≠dos
console.log('hideColaboradorModal: Classes do overlay:', colaboradorModalOverlay.classList);
console.log('hideColaboradorModal: Current display style:', colaboradorModalOverlay.style.display); // NOVO: Log do estilo display
}

// NOVO: Event Listeners para o Modal de Hist√≥rico
showHistoryButton.addEventListener('click', () => {
console.log('showHistoryButton: Clicado');
showHistoryModal();
});
closeHistoryModalButton.addEventListener('click', () => {
console.log('closeHistoryModalButton: Clicado');
hideHistoryModal();
});
historyModalOverlay.addEventListener('click', (e) => {
if (e.target === historyModalOverlay) {
    console.log('historyModalOverlay: Clicado no overlay');
    hideHistoryModal();
}
});

// NOVO: Event Listeners para o Modal de Cadastro
closeRegistrationModalButton.addEventListener('click', () => {
console.log('closeRegistrationModalButton: Clicado');
hideRegistrationModal();
// Opcional: Limpar a chapa do input principal se o cadastro for cancelado
chapaInputModal.value = '';
textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
chapaBeingProcessed = null;
});
registrationModalOverlay.addEventListener('click', (e) => {
if (e.target === registrationModalOverlay) {
    console.log('registrationModalOverlay: Clicado no overlay');
    hideRegistrationModal();
    chapaInputModal.value = '';
    textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
    chapaBeingProcessed = null;
}
});
submitRegistrationButton.addEventListener('click', () => {
console.log('submitRegistrationButton: Clicado');
const nomeCompleto = regNomeCompletoInput.value.trim();
const chapa = regChapaInput.value.trim();
const telefone = regTelefoneInput.value.trim();

if (!nomeCompleto || !chapa || !telefone) {
    registrationErrorMessage.textContent = 'Por favor, preencha todos os campos.';
    registrationErrorMessage.classList.remove('hidden');
    return;
}

// Armazena temporariamente os dados de registro (sem a senha e frase secreta ainda)
registeredUsers[chapa] = {
    nomeCompleto: nomeCompleto,
    telefone: telefone,
    password: null, // A senha ser√° definida no pr√≥ximo passo
    secretPhrase: null // A frase secreta ser√° definida no pr√≥ximo passo
};

hideRegistrationModal();
showPasswordSetupModal(); // Abre o modal para definir a senha e frase secreta
});

// NOVO: Event Listeners para o Modal de Defini√ß√£o de Senha
closePasswordSetupModalButton.addEventListener('click', () => {
console.log('closePasswordSetupModalButton: Clicado');
hidePasswordSetupModal();
// Se o usu√°rio cancelar a defini√ß√£o de senha, remove o registro tempor√°rio
if (chapaBeingProcessed && registeredUsers[chapaBeingProcessed] && registeredUsers[chapaBeingProcessed].password === null) {
    delete registeredUsers[chapaBeingProcessed];
}
chapaInputModal.value = '';
textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
chapaBeingProcessed = null;
});
passwordSetupModalOverlay.addEventListener('click', (e) => {
if (e.target === passwordSetupModalOverlay) {
    console.log('passwordSetupModalOverlay: Clicado no overlay');
    hidePasswordSetupModal();
    if (chapaBeingProcessed && registeredUsers[chapaBeingProcessed] && registeredUsers[chapaBeingProcessed].password === null) {
        delete registeredUsers[chapaBeingProcessed];
    }
    chapaInputModal.value = '';
    textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
    chapaBeingProcessed = null;
}
});
setPasswordButton.addEventListener('click', () => {
console.log('setPasswordButton: Clicado');
// Obt√©m os valores diretamente dos elementos com os IDs √∫nicos
const newPass = document.getElementById('setupNewPassword').value;
const confirmPass = document.getElementById('setupConfirmPassword').value;
const secretPhrase = document.getElementById('setupSecretPhrase').value.trim();
const confirmSecretPhrase = document.getElementById('setupConfirmSecretPhrase').value.trim();

if (!newPass || !confirmPass || !secretPhrase || !confirmSecretPhrase) { // Valida todos os campos
    passwordSetupErrorMessage.textContent = 'Por favor, preencha todos os campos (senha e frase secreta).';
    passwordSetupErrorMessage.classList.remove('hidden');
    return;
}
if (newPass !== confirmPass) {
    passwordSetupErrorMessage.textContent = 'As senhas n√£o coincidem.';
    passwordSetupErrorMessage.classList.remove('hidden');
    return;
}
if (newPass.length < 6) { // Exemplo de valida√ß√£o de senha
    passwordSetupErrorMessage.textContent = 'A senha deve ter pelo menos 6 caracteres.';
    passwordSetupErrorMessage.classList.remove('hidden');
    return;
}
if (secretPhrase.length < 3) { // Exemplo de valida√ß√£o de frase secreta
    passwordSetupErrorMessage.textContent = 'A frase secreta deve ter pelo menos 3 caracteres.';
    passwordSetupErrorMessage.classList.remove('hidden');
    return;
}
if (secretPhrase !== confirmSecretPhrase) { // Valida a frase secreta
    passwordSetupErrorMessage.textContent = 'As frases secretas n√£o coincidem.';
    passwordSetupErrorMessage.classList.remove('hidden');
    return;
}


const chapa = chapaBeingProcessed; // Usa a chapa que est√° sendo processada
if (chapa && registeredUsers[chapa]) {
    registeredUsers[chapa].password = newPass; // Salva a senha
    registeredUsers[chapa].secretPhrase = secretPhrase; // Salva a frase secreta
    hidePasswordSetupModal();
    displayConsultationResults(); // Exibe os resultados ap√≥s o cadastro da senha
    chapaBeingProcessed = null;
} else {
    passwordSetupErrorMessage.textContent = 'Erro: Chapa n√£o identificada para cadastro de senha.';
    passwordSetupErrorMessage.classList.remove('hidden');
}
});

// NOVO: Event Listeners para o Modal de Solicita√ß√£o de Senha
closePasswordPromptModalButton.addEventListener('click', () => {
console.log('closePasswordPromptModalButton: Clicado');
hidePasswordPromptModal();
chapaInputModal.value = '';
textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
chapaBeingProcessed = null;
});
passwordPromptModalOverlay.addEventListener('click', (e) => {
if (e.target === passwordPromptModalOverlay) {
    console.log('passwordPromptModalOverlay: Clicado no overlay');
    hidePasswordPromptModal();
    chapaInputModal.value = '';
    textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
    chapaBeingProcessed = null;
}
});
submitPasswordPromptButton.addEventListener('click', () => {
console.log('submitPasswordPromptButton: Clicado');
const enteredPassword = promptPasswordInput.value;
const chapa = chapaBeingProcessed; // Usa a chapa que est√° sendo processada

if (chapa && registeredUsers[chapa] && registeredUsers[chapa].password === enteredPassword) {
    hidePasswordPromptModal();
    displayConsultationResults(); // Exibe os resultados ap√≥s a senha correta
    chapaBeingProcessed = null;
} else {
    passwordPromptErrorMessage.textContent = 'Senha incorreta. Tente novamente.';
    passwordPromptErrorMessage.classList.remove('hidden');
    promptPasswordInput.value = '';
}
});

// NOVO: Event Listener para o bot√£o "Esqueci minha senha"
forgotPasswordButton.addEventListener('click', () => {
console.log('forgotPasswordButton: Clicado');
hidePasswordPromptModal(); // Esconde o modal de solicita√ß√£o de senha
showForgotPasswordModal(chapaBeingProcessed); // Abre o modal de recupera√ß√£o de senha
});

// NOVO: Event Listeners para o Modal de Recupera√ß√£o de Senha
closeForgotPasswordModalButton.addEventListener('click', () => {
console.log('closeForgotPasswordModalButton: Clicado');
hideForgotPasswordModal();
chapaInputModal.value = '';
textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
chapaBeingProcessed = null;
});
forgotPasswordModalOverlay.addEventListener('click', (e) => {
if (e.target === forgotPasswordModalOverlay) {
    console.log('forgotPasswordModalOverlay: Clicado no overlay');
    hideForgotPasswordModal();
    chapaInputModal.value = '';
    textResults.innerHTML = '<p class="initial-message">Digite sua chapa para consultar seu saldo.</p>';
    chapaBeingProcessed = null;
}
});
verifyForgotPasswordButton.addEventListener('click', () => {
console.log('verifyForgotPasswordButton: Clicado');
const chapa = forgotChapaInput.value.trim();
const telefone = forgotTelefoneInput.value.trim();
const secretPhrase = forgotSecretPhraseInput.value.trim(); // NOVO

if (!chapa || !telefone || !secretPhrase) { // NOVO: Valida todos os campos
    forgotPasswordErrorMessage.textContent = 'Por favor, preencha a chapa, o telefone e a frase secreta.';
    forgotPasswordErrorMessage.classList.remove('hidden');
    return;
}

// NOVO: Verifica chapa, telefone E frase secreta
if (registeredUsers[chapa] && 
    registeredUsers[chapa].telefone === telefone &&
    registeredUsers[chapa].secretPhrase === secretPhrase) {
    hideForgotPasswordModal();
    chapaBeingProcessed = chapa; // Garante que a chapa correta seja usada para definir a nova senha
    showTokenConfirmationModal(chapa, { password: null, secretPhrase: null }); // Abre o modal de token para redefinir senha
} else {
    forgotPasswordErrorMessage.textContent = 'Chapa, telefone ou frase secreta incorretos.';
    forgotPasswordErrorMessage.classList.remove('hidden');
}
});

// NOVO: Event Listeners para o Modal de Confirma√ß√£o de Token
closeTokenConfirmationModalButton.addEventListener('click', () => {
console.log('closeTokenConfirmationModalButton: Clicado');
hideTokenConfirmationModal();
// Se o usu√°rio fechar o modal de token, volta para a aba de atualiza√ß√£o de dados
showColaboradorModal();
showTab('atualizarDados');
updateDataErrorMessage.textContent = 'Altera√ß√µes canceladas. Confirma√ß√£o de token n√£o realizada.';
updateDataErrorMessage.classList.remove('hidden');
updateDataSuccessMessage.classList.add('hidden');
});
tokenConfirmationModalOverlay.addEventListener('click', (e) => {
if (e.target === tokenConfirmationModalOverlay) {
    console.log('tokenConfirmationModalModalOverlay: Clicado no overlay');
    hideTokenConfirmationModal();
    showColaboradorModal();
    showTab('atualizarDados');
    updateDataErrorMessage.textContent = 'Altera√ß√µes canceladas. Confirma√ß√£o de token n√£o realizada.';
    updateDataErrorMessage.classList.remove('hidden');
    updateDataSuccessMessage.classList.add('hidden');
}
});
confirmTokenButton.addEventListener('click', () => {
console.log('confirmTokenButton: Clicado');
const enteredToken = tokenInput.value.trim();

if (Date.now() > tokenExpirationTime) {
    tokenErrorMessage.textContent = 'O token expirou. Por favor, gere um novo.';
    tokenErrorMessage.classList.remove('hidden');
    tokenInput.disabled = true;
    confirmTokenButton.disabled = true;
    return;
}

if (enteredToken === generatedToken) {
    // Token v√°lido, salva as altera√ß√µes pendentes
    if (chapaBeingProcessed && pendingUserDataChanges) {
        // Se a senha e frase secreta est√£o sendo redefinidas (fluxo de "Esqueci minha senha")
        if (pendingUserDataChanges.password === null && pendingUserDataChanges.secretPhrase === null) {
            // Abre o modal de defini√ß√£o de senha para o usu√°rio definir a nova senha e frase secreta
            hideTokenConfirmationModal();
            showPasswordSetupModal();
            passwordSetupErrorMessage.textContent = 'Token confirmado. Por favor, defina sua nova senha e frase secreta.';
            passwordSetupErrorMessage.classList.remove('hidden');
        } else {
            // Caso contr√°rio, aplica as altera√ß√µes normais (telefone, etc.)
            registeredUsers[chapaBeingProcessed] = {
                ...registeredUsers[chapaBeingProcessed], // Mant√©m dados existentes
                ...pendingUserDataChanges // Aplica as altera√ß√µes
            };
        
            hideTokenConfirmationModal();
            showColaboradorModal();
            // ALTERA√á√ÉO AQUI: Redireciona para a aba 'consultarHoras'
            showTab('consultarHoras'); 
            updateDataSuccessMessage.textContent = 'Dados atualizados com sucesso!';
            updateDataSuccessMessage.classList.remove('hidden');
            updateDataErrorMessage.classList.add('hidden');
            // Limpa os campos de senha e frase secreta ap√≥s a atualiza√ß√£o bem-sucedida
            updateNewPasswordInput.value = '';
            updateConfirmNewPasswordInput.value = '';
            updateSecretPhraseInput.value = '';
            updateConfirmSecretPhraseInput.value = '';
        }
    } else {
        tokenErrorMessage.textContent = 'Erro interno: Dados pendentes n√£o encontrados.';
        tokenErrorMessage.classList.remove('hidden');
    }
} else {
    tokenErrorMessage.textContent = 'Token incorreto. Tente novamente.';
    tokenErrorMessage.classList.remove('hidden');
    tokenInput.value = '';
}
});
resendTokenButton.addEventListener('click', () => {
console.log('resendTokenButton: Clicado');
generateAndDisplayToken();
tokenErrorMessage.classList.add('hidden');
});


// Desabilita bot√µes de busca e visualiza√ß√£o at√© que um arquivo seja carregado
// A condi√ß√£o agora verifica se overtimeData j√° tem dados carregados do localStorage
searchButtonModal.disabled = true;
showAllButton.disabled = true;
printPdfButton.disabled = true; 
searchByCargoButton.disabled = true; 
sendWhatsappButton.disabled = true; 
downloadSpecificPdfButton.disabled = true; 

// NOVO: Fun√ß√£o para carregar dados do horas.html
async function loadDataFromHorasHtml() {
console.log('loadDataFromHorasHtml: Iniciando carregamento de dados do horas.html');
try {
    const response = await fetch('/horas.html');
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    const htmlText = await response.text();
    
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, 'text/html');
    const table = doc.querySelector('table');

    if (!table) {
        throw new Error('Tabela n√£o encontrada no horas.html');
    }

    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    const newOvertimeData = [];
    const today = new Date().toISOString().slice(0, 10); // Formato YYYY-MM-DD

    table.querySelectorAll('tbody tr').forEach(row => {
        const rowData = {};
        Array.from(row.querySelectorAll('td')).forEach((cell, index) => {
            const headerName = headers[index];
            let cellValue = cell.textContent.trim();
            
            // Mapeamento de colunas para o formato esperado
            if (headerName === 'N¬∞ Chapa') {
                rowData['CHAPA'] = cellValue;
            } else if (headerName === 'Nome') {
                rowData['Nome'] = cellValue;
            } else if (headerName === 'Fun√ß√£o') {
                rowData['Fun√ß√£o'] = cellValue;
            } else if (headerName === 'L√≠der') {
                rowData['L√≠der'] = cellValue;
            } else if (headerName === 'Turno') {
                rowData['Turno'] = cellValue; // Este √© o campo que cont√©m as horas (saldo)
            } else if (headerName === 'Status') {
                rowData['Status'] = cellValue;
            }
        });
        newOvertimeData.push(rowData);

        // Adiciona ao hist√≥rico
        const chapa = String(rowData.CHAPA);
        const saldoMinutes = timeToMinutes(rowData['Turno']); // Usando 'Turno' como Saldo Final
        const positiveMinutes = Math.max(0, saldoMinutes);

        if (!employeeHistory[chapa]) {
            employeeHistory[chapa] = [];
        }
        const existingEntryIndex = employeeHistory[chapa].findIndex(entry => entry.date === today);
        if (existingEntryIndex > -1) {
            employeeHistory[chapa][existingEntryIndex] = { date: today, totalMinutes: saldoMinutes, positiveMinutes: positiveMinutes };
        } else {
            employeeHistory[chapa].push({ date: today, totalMinutes: saldoMinutes, positiveMinutes: positiveMinutes });
        }
    });

    overtimeData = newOvertimeData;
    console.log('Dados carregados do horas.html:', overtimeData);
    console.log('Hist√≥rico de funcion√°rios atualizado:', employeeHistory);

    // Habilita os bot√µes ap√≥s o carregamento bem-sucedido
    searchButtonModal.disabled = false;
    showAllButton.disabled = false;
    printPdfButton.disabled = false; 
    searchByCargoButton.disabled = false; 
    sendWhatsappButton.disabled = false; 
    downloadSpecificPdfButton.disabled = false; 

    displayRecordsAndChart(overtimeData, 'Todos os Registros'); // Exibe todos os registros e o gr√°fico ap√≥s o carregamento
    cargoInputAdmin.value = ''; // Limpa o campo de busca por cargo

} catch (error) {
    console.error('Erro ao carregar dados do horas.html:', error);
    allRecordsTable.innerHTML = '<p class="error">Erro ao carregar dados do arquivo horas.html. Verifique o console para detalhes.</p>';
    // Garante que os bot√µes permane√ßam desabilitados em caso de erro
    searchButtonModal.disabled = true;
    showAllButton.disabled = true;
    printPdfButton.disabled = true; 
    searchByCargoButton.disabled = true; 
    sendWhatsappButton.disabled = true; 
    downloadSpecificPdfButton.disabled = true; 
}
}


openColaboradorModalButton.addEventListener('click', () => {
console.log('openColaboradorModalButton: Clicado - IN√çCIO');
resetColaboradorModalContent(); // Reseta o conte√∫do ao abrir o modal pela primeira vez
showColaboradorModal(); // Apenas mostra o modal
console.log('openColaboradorModalButton: Clicado - FIM, showColaboradorModal chamado.');
});

closeColaboradorModalButton.addEventListener('click', () => {
console.log('closeColaboradorModalButton: Clicado - IN√çCIO');
hideColaboradorModal();
console.log('closeColaboradorModalButton: Clicado - FIM, hideColaboradorModal chamado.');
});

searchButtonModal.addEventListener('click', () => {
console.log('searchButtonModal: Clicado');
const chapa = chapaInputModal.value.trim();
textResults.innerHTML = '';
showHistoryButton.classList.add('hidden'); // Esconde o bot√£o de hist√≥rico at√© a busca ser bem-sucedida
currentConsultedRecord = null; // Limpa o registro consultado
updateDateTime();

console.log('searchButtonModal: Chapa digitada:', chapa); // NOVO LOG
console.log('searchButtonModal: Dados de horas extras carregados (overtimeData.length):', overtimeData.length); // NOVO LOG
console.log('searchButtonModal: Conte√∫do de overtimeData (primeiros 5 registros):', overtimeData.slice(0, 5)); // NOVO LOG

if (overtimeData.length === 0) {
    textResults.innerHTML = '<p class="error">Nenhum dado de horas extras carregado. Por favor, verifique o arquivo horas.html.</p>';
    return;
}

if (!chapa) {
    textResults.innerHTML = '<p class="error">Por favor, digite o n√∫mero da Chapa.</p>';
    return;
}

const foundRecord = overtimeData.find(record => String(record.CHAPA) === chapa);
console.log('searchButtonModal: Registro encontrado:', foundRecord); // NOVO LOG

if (foundRecord) {
    currentConsultedRecord = foundRecord; // Armazena o registro encontrado

    if (registeredUsers[chapa]) {
        // Usu√°rio j√° cadastrado, pede a senha
        hideColaboradorModal(); // Esconde o modal principal de colaborador
        showPasswordPromptModal(chapa);
    } else {
        // Primeiro acesso, pede para cadastrar
        hideColaboradorModal(); // Esconde o modal principal de colaborador
        showRegistrationModal(chapa);
    }
} else {
    textResults.innerHTML = `<p class="error">Chapa "${chapa}" n√£o encontrada.</p>`;
    showHistoryButton.classList.add('hidden'); // Garante que o bot√£o esteja oculto
}
});

showAllButton.addEventListener('click', () => {
console.log('showAllButton: Clicado');
displayRecordsAndChart(overtimeData, 'Todos os Registros');
cargoInputAdmin.value = ''; // Limpa o campo de busca por cargo
});

// NOVO: Event Listener para o bot√£o de busca por cargo
searchByCargoButton.addEventListener('click', () => {
console.log('searchByCargoButton: Clicado');
const cargo = cargoInputAdmin.value.trim();
if (!cargo) {
    alert('Por favor, digite um cargo para buscar.');
    return;
}

if (overtimeData.length === 0) {
    alert('Nenhum dado carregado para buscar. Por favor, verifique o arquivo horas.html.');
    return;
}

const filteredData = overtimeData.filter(record => 
    record.Fun√ß√£o && String(record.Fun√ß√£o).toLowerCase().includes(cargo.toLowerCase()) // Usando 'Fun√ß√£o'
);

displayRecordsAndChart(filteredData, `Registros Filtrados por Cargo: "${cargo}"`);
});

// NOVO: Event Listener para o bot√£o de imprimir PDF
printPdfButton.addEventListener('click', generatePdfReport);

// NOVO: Event Listener para o input da chapa do WhatsApp para exibir o nome
chapaWhatsappInput.addEventListener('input', () => {
const chapa = chapaWhatsappInput.value.trim();
if (chapa && overtimeData.length > 0) {
    const foundRecord = overtimeData.find(record => String(record.CHAPA) === chapa);
    if (foundRecord) {
        whatsappCollaboratorNameDisplay.textContent = `(${foundRecord.Nome})`;
    } else {
        whatsappCollaboratorNameDisplay.textContent = '(Colaborador n√£o encontrado)';
    }
} else {
    whatsappCollaboratorNameDisplay.textContent = '';
}
});

// NOVO: Event Listener para o bot√£o de enviar WhatsApp
sendWhatsappButton.addEventListener('click', handleSendWhatsappReport);

// NOVO: Event Listener para o bot√£o de baixar PDF espec√≠fico
downloadSpecificPdfButton.addEventListener('click', handleDownloadSpecificPdfReport);


// NOVO: L√≥gica de Abas para o Modal do Colaborador
function showTab(tabName) {
// Desativa todas as abas e esconde todo o conte√∫do
consultarHorasTabButton.classList.remove('active');
atualizarDadosTabButton.classList.remove('active');
consultarHorasTabContent.classList.add('hidden');
atualizarDadosTabContent.classList.add('hidden');

// Ativa a aba selecionada e mostra seu conte√∫do
if (tabName === 'consultarHoras') {
    consultarHorasTabButton.classList.add('active');
    consultarHorasTabContent.classList.remove('hidden');
} else if (tabName === 'atualizarDados') {
    // Verifica se h√° um registro consultado antes de permitir a aba de atualiza√ß√£o
    if (!currentConsultedRecord) {
        alert('Por favor, consulte sua chapa primeiro para acessar a √°rea de atualiza√ß√£o de dados.');
        showTab('consultarHoras'); // Volta para a aba de consulta
        return;
    }
    atualizarDadosTabButton.classList.add('active');
    atualizarDadosTabContent.classList.remove('hidden');
    populateUpdateDataForm(); // Preenche o formul√°rio ao mostrar a aba
}
}

// Event Listeners para os bot√µes das abas
consultarHorasTabButton.addEventListener('click', () => showTab('consultarHoras'));
atualizarDadosTabButton.addEventListener('click', () => showTab('atualizarDados'));

// NOVO: Fun√ß√£o para preencher o formul√°rio de atualiza√ß√£o de dados
function populateUpdateDataForm() {
if (currentConsultedRecord) {
    const chapa = String(currentConsultedRecord.CHAPA);
    const userData = registeredUsers[chapa];

    // Nome Completo, Chapa e Cargo s√£o preenchidos com dados do Excel e s√£o somente leitura
    updateNomeCompletoInput.value = currentConsultedRecord.Nome || '';
    updateChapaInput.value = chapa; // Somente leitura
    updateCargoInput.value = currentConsultedRecord.Fun√ß√£o || ''; // Usando 'Fun√ß√£o' como Cargo, somente leitura
    
    // Telefone √© preenchido com dados do registro do usu√°rio (se existir)
    updateTelefoneInput.value = userData ? userData.telefone : '';

    // Limpa os campos de senha e frase secreta por seguran√ßa
    updateNewPasswordInput.value = '';
    updateConfirmNewPasswordInput.value = '';
    updateSecretPhraseInput.value = '';
    updateConfirmSecretPhraseInput.value = '';

    updateDataErrorMessage.classList.add('hidden');
    updateDataSuccessMessage.classList.add('hidden');
}
}

// NOVO: Event Listener para o bot√£o "Salvar Altera√ß√µes"
saveChangesButton.addEventListener('click', () => {
console.log('saveChangesButton: Clicado');
if (!currentConsultedRecord) {
    updateDataErrorMessage.textContent = 'Nenhum colaborador selecionado para atualiza√ß√£o.';
    updateDataErrorMessage.classList.remove('hidden');
    updateDataSuccessMessage.classList.add('hidden');
    return;
}

const chapa = String(currentConsultedRecord.CHAPA);
const userData = registeredUsers[chapa]; // Dados atuais do usu√°rio

const newTelefone = updateTelefoneInput.value.trim();
const newPassword = updateNewPasswordInput.value;
const confirmNewPassword = updateConfirmNewPasswordInput.value;
const newSecretPhrase = updateSecretPhraseInput.value.trim();
const confirmNewSecretPhrase = updateConfirmSecretPhraseInput.value.trim();

let changes = {};
let hasChanges = false;

// Verifica e coleta altera√ß√µes no telefone
if (newTelefone !== (userData ? userData.telefone : '')) {
    changes.telefone = newTelefone;
    hasChanges = true;
}

// Verifica e coleta altera√ß√µes na senha
if (newPassword || confirmNewPassword) {
    if (newPassword !== confirmNewPassword) {
        updateDataErrorMessage.textContent = 'As novas senhas n√£o coincidem.';
        updateDataErrorMessage.classList.remove('hidden');
        updateDataSuccessMessage.classList.add('hidden');
        return;
    }
    if (newPassword.length < 6) {
        updateDataErrorMessage.textContent = 'A nova senha deve ter pelo menos 6 caracteres.';
        updateDataErrorMessage.classList.remove('hidden');
        updateDataSuccessMessage.classList.add('hidden');
        return;
    }
    changes.password = newPassword;
    hasChanges = true;
}

// Verifica e coleta altera√ß√µes na frase secreta
if (newSecretPhrase || confirmNewSecretPhrase) {
    if (newSecretPhrase !== confirmNewSecretPhrase) {
        updateDataErrorMessage.textContent = 'As novas frases secretas n√£o coincidem.';
        updateDataErrorMessage.classList.remove('hidden');
        updateDataSuccessMessage.classList.add('hidden');
        return;
    }
    if (newSecretPhrase.length < 3) {
        updateDataErrorMessage.textContent = 'A nova frase secreta deve ter pelo menos 3 caracteres.';
        updateDataErrorMessage.classList.remove('hidden');
        updateDataSuccessMessage.classList.add('hidden');
        return;
    }
    changes.secretPhrase = newSecretPhrase;
    hasChanges = true;
}

if (!hasChanges) {
    updateDataErrorMessage.textContent = 'Nenhuma altera√ß√£o detectada para salvar.';
    updateDataErrorMessage.classList.remove('hidden');
    updateDataSuccessMessage.classList.add('hidden');
    return;
}

// Se houver altera√ß√µes, mostra o modal de confirma√ß√£o de token
showTokenConfirmationModal(chapa, changes);
updateDataErrorMessage.classList.add('hidden');
updateDataSuccessMessage.classList.add('hidden');
});


// NOVO: Event Listener para o input da chapa no gerenciamento de telefones
manageChapaInput.addEventListener('input', () => {
const chapa = manageChapaInput.value.trim();
if (chapa && overtimeData.length > 0) {
    const foundRecord = overtimeData.find(record => String(record.CHAPA) === chapa);
    if (foundRecord) {
        manageCollaboratorNameDisplay.textContent = `(${foundRecord.Nome})`;
        const userData = registeredUsers[chapa];
        managePhoneNumberInput.value = userData ? userData.telefone : ''; // Preenche o telefone se j√° cadastrado
    } else {
        manageCollaboratorNameDisplay.textContent = '(Colaborador n√£o encontrado)';
    }
} else {
    manageCollaboratorNameDisplay.textContent = '';
    managePhoneNumberInput.value = '';
}
managePhoneNumberStatusMessage.classList.add('hidden'); // Esconde a mensagem de status ao digitar
});

// NOVO: Event Listener para o bot√£o Salvar Telefone
savePhoneNumberButton.addEventListener('click', () => {
console.log('savePhoneNumberButton: Clicado');
const chapa = manageChapaInput.value.trim();
const telefone = managePhoneNumberInput.value.trim();

managePhoneNumberStatusMessage.classList.add('hidden'); // Esconde mensagens anteriores

if (!chapa || !telefone) {
    managePhoneNumberStatusMessage.textContent = 'Por favor, preencha a chapa e o telefone.';
    managePhoneNumberStatusMessage.className = 'error';
    managePhoneNumberStatusMessage.classList.remove('hidden');
    return;
}

const foundRecord = overtimeData.find(record => String(record.CHAPA) === chapa);
if (!foundRecord) {
    managePhoneNumberStatusMessage.textContent = `Chapa "${chapa}" n√£o encontrada nos dados carregados.`;
    managePhoneNumberStatusMessage.className = 'error';
    managePhoneNumberStatusMessage.classList.remove('hidden');
    return;
}

// Se o usu√°rio n√£o existe, cria um novo registro b√°sico
if (!registeredUsers[chapa]) {
    registeredUsers[chapa] = {
        nomeCompleto: foundRecord.Nome, // Pega o nome do Excel
        telefone: telefone,
        password: null, // Sem senha inicial
        secretPhrase: null // Sem frase secreta inicial
    };
} else {
    // Se o usu√°rio existe, apenas atualiza o telefone
    registeredUsers[chapa].telefone = telefone;
}

managePhoneNumberStatusMessage.textContent = `Telefone para chapa ${chapa} (${foundRecord.Nome}) salvo com sucesso!`;
managePhoneNumberStatusMessage.className = 'success';
managePhoneNumberStatusMessage.classList.remove('hidden');
console.log('Telefone salvo/atualizado:', registeredUsers[chapa]);
});


// Inicializa√ß√£o
updateDateTime(); // Atualiza a data e hora ao carregar a p√°gina
loadDataFromHorasHtml(); // Carrega os dados do horas.html ao iniciar
</script>
</body>
</html>
